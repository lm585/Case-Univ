ls -l  | grep ^d | awk '{print $9}' > dir-list
bash -x script-genecount-merge 
paste */temp-*.htseq.counts > temp.txt
 vi  temp.txt ###rm mapping stat lines
bash  ../../dir-star-hiv/dir-map-stat/script-check-gene-order | wc -l
bash  ../../dir-star-hiv/dir-map-stat/script-sel-colum-for-geneCount-table > tcga-AA-ser-normBMI-7peop.count.txt

$ cat tcga-AA-ser-ge30BMI-gdc_sample_sheet.2020-06-12.tsv tcga-AA-ser-normBMI-gdc_sample_sheet.2020-06-10.tsv  | cut -f 2,6 
File Name	Case ID
3949d143-ea2f-49b8-a003-5e49d06fde1a.htseq.counts.gz	TCGA-B5-A1N2
db7b7f18-8a34-466f-b93a-087309fd68b9.htseq.counts.gz	TCGA-FI-A3PV

cat tcga-AA-ser-ge30BMI-gdc_sample_sheet.2020-06-12.tsv tcga-AA-ser-normBMI-gdc_sample_sheet.2020-06-10.tsv  | cut -f 2,6 | sed 's/.htseq.counts.gz//' | sort -t '	' +1 -2 > temp-countFIle-caseIDsorted
cat tcga-AA-ser-ge30BMI-clinical.cases_selection.2020-06-12/clinical.tsv tcga-AA-ser-normBMI-clinical.cart.2020-06-10/clinical.tsv | cut -f 2,15,20 | sort | uniq | sort -t '	' +0 -1 > temp-caseIDsorted-AA-age
### TCGA-B5-A1N2	black or african american	25612
### TCGA-FI-A3PV	black or african american	24898
cat tcga-AA-ser-ge30BMI-clinical.cases_selection.2020-06-12/exposure.tsv tcga-AA-ser-normBMI-clinical.cart.2020-06-10/exposure.tsv | cut -f 2,10 | sort | uniq | sort -t '	' +0 -1  > temp-caseIDsorted-BMI
### TCGA-B5-A1N2	40
### TCGA-FI-A3PV	34
join -t '	' -1 1 -2 1 temp-caseIDsorted-AA-age temp-caseIDsorted-BMI > temp-caseIDsorted-AA-age-bmi
join -t '	' -1 1 -2 2 temp-caseIDsorted-AA-age-bmi temp-countFIle-caseIDsorted > tcga-AA-ser-29samples.samp-info.txt
bash  script-make-samp-info-1 > temp-719
mv  temp-719 tcga-AA-ser-29samples.samp-info.coded.txt
vi tcga-AA-ser-29samples.samp-info.coded.txt

paste tcga-AA-ser-normBMI-gdc_download_20200610_213936.529123/tcga-AA-ser-normBMI-7peop.count.txt temp1 > tcga-AA-ser-29samples.count.txt 
###7 samples normal BMI + 22 samples BMI >= 30
head -1 tcga-AA-ser-29samples.count.txt | awk 'BEGIN {FS = "\t"; OFS = "\t"} {for(i = 2; i <= NF; i++) print  $i}' > temp-head
cat temp-head | while read ll; do grep -i "$ll" tcga-AA-ser-29samples.samp-info.coded.txt; done | cut -f 1,4,5 > factor.tcga-AA-ser-29samples.txt
vi factor.tcga-AA-ser-29samples.txt

### rawCount <- read.delim("tcga-AA-ser-29samples.count.txt", header = T, row.names = 1)
### group <- factor(rep(1, 29))

> dim(y)
[1] 60483    29
> keep <-rowSums(cpm(y)>=1) >= 6
> y<-y[keep,]
> dim(y)
[1] 18376    29
> targets <- read.delim("factor.tcga-AA-ser-29samples.txt", row.names=1)
> age <- factor(targets$age)
> treat <- factor(targets$bmi)
> design <- model.matrix(~age+treat)
> design
   (Intercept) age60 age70 age80 treatobesity
1            1     0     0     0            0
2            1     1     0     0            0
3            1     0     0     1            0
4            1     1     0     0            0
> y <- estimateDisp(y,design)
> fit <- glmQLFit(y, design)
> qlf <- glmQLFTest(fit) 
###eq to coef= 5
> top2v1 <- topTags(qlf, n = 91234)
> write.table(top2v1, "diff2-1.txt", sep="\t")
mv -i diff2-1.txt tcga-AA-ser-29samples.edgeR.model.diff2-1.txt

awk '$5 < 0.005' tcga-AA-ser-29samples.edgeR.model.diff2-1.txt | cut -f 1 | sed 's/"//' | sed 's/\.[0-9]*"//' > tcga-AA-ser-29samples.DEG.p0d005.genes
awk '$5 < 0.001' tcga-AA-ser-29samples.edgeR.model.diff2-1.txt | cut -f 1 | sed 's/"//' | sed 's/\.[0-9]*"//' > tcga-AA-ser-29samples.DEG.p0d001.genes

###prepare prerank file
bash  script-preRank-genes  tcga-AA-ser-29samples.edgeR.model.diff2-1.txt > temp-1
vi temp-1
 sort -t '	' +0 -1 temp-1 > temp-1-sorted
 cat ../dir-star-hiv/GRCh38-geneID-name | sort -t '	' +0 -1 > temp-GRCh38-geneID-name
 join -t '	' -1 1 -2 1 temp-1-sorted temp-GRCh38-geneID-name  | awk 'BEGIN {FS = "\t"; OFS = "\t"} {print $3, $2}' > temp-rank
bash  ../methyl-seq-TEM-2/script-preRank-genes-methyl-step-2 > temp-rank-uniq
cut -f 1 temp-rank | sort | uniq -c | awk '$1 > 1'
vi temp-rank-uniq #### :1, $ s/^I$/^I0/

chmod -w tcga-AA-ser-29samples.ageAsBlock.rnk

"/Users/linyongmao/gsea_home/output/may05/tcga-AA-ser-29samples.ageAsBlock.hallmarkv7.1.GseaPreranked.1592419333891/gsea_report_for_na_pos_1592419333891.xls"
"/Users/linyongmao/gsea_home/output/may05/tcga-AA-ser-29samples.ageAsBlock.hallmarkv7.1.GseaPreranked.1592419333891/gsea_report_for_na_neg_1592419333891.xls"

cat temp-up.path | while read p
do
  echo "$p"
  cat "$p.xls" | awk '
 BEGIN {FS = "\t";}
  {
   if($8 == "Yes")
   {
    print $2;
   }
  } 
' | grep -v -w PROBE > temp-lead-genes."$p".xls
 wc -l temp-lead-genes."$p".xls
done

bash script-TF-targets-enrich > temp1
bash script-TF-targets-enrich-overlapGenes > temp2
vi temp2
paste temp1 temp2 > temp.xls

cat serous-* | while read g; do grep -w "$g" tcga-AA-ser-29samples.ageAsBlock.rnk; done > temp.xls

bash /Users/linyongmao/Documents/dir-cancer-endometrial/script-get-leadingEdgeGenes-listOfPathways > temp.xls

cut -f 1 temp-caseID-age-bmi | while read ll; do grep -w "$ll" sample-sheet.cancerOnly.txt ; done  | cut -f 2,6,8 > temp-1
cut -f 2 temp-1 | while read ll; do grep -w "$ll" temp-caseID-age-bmi ; done  > temp-2
paste temp-1 temp-2 | cut -f 1,2,3,5-20 > tcga-white-serous-65samp-info.txt
ls */temp*.htseq.counts > temp.txt
cut -f 1 ../tcga-white-serous-65samp-info.txt | sed 's/.gz//' | while read f; do grep "temp-$f$" temp.txt; done | sed 's#/temp-.*##' > dir-list ###select samples with BMI info
rm */temp-*.htseq.counts

cat tcga-white-serous-65samp-info.txt | awk 'BEGIN {FS = "\t"; OFS = "\t"} $7 < 18.5 || $6 < 365*50' | cut -f 1 > temp-rm-cases
cut -f 1 tcga-white-serous-65samp-info.txt > temp
cat temp-rm-cases temp | sort | uniq -u > temp-keep-cases
head -1 tcga-white-serous-65samp.count.txt | awk 'BEGIN {FS = "\t"; OFS = "\t"} {for(i = 1; i <= NF; i++) print i, $i}'  > temp-colm-case
###using join to retrieve columns to be kept
cut -f 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,48,50,51,52,53,54,55,56,57,58,59,60,61,62,63,65,66  tcga-white-serous-65samp.count.txt > tcga-white-serous-62samp.count.txt
> y <- calcNormFactors(y)
....
> x <- read.delim("tcga-white-serous-62samp.CPM.txt", header = T, row.names = 1)
> keep <- rowMeans(x) >= 1
> x <- x[keep,]
> dim(x)
[1] 17275    62
> write.table(x, "temp.xls", sep = "\t")
cut -f 1 temp.xls > tcga-white-serous-62samp.CPMavgGE1.genes

head -1 tcga-white-serous-62samp.count.txt | awk 'BEGIN {FS = "\t"; OFS = "\t"} {for(i = 1; i <= NF; i++) print  $i}'  > factor
cat factor | while read f; do grep -w "$f" tcga-white-serous-65samp-info.dchip.txt ; done  | cut -f 1,4,5 > factor-2
vi factor-2
mv -i factor-2 factor-tcga-white-serous-62samp.txt




###########################################################
> rawCount <- read.delim("tcga-white-serous-62samp.count.txt", header = T, row.names = 1)
> dim(rawCount)
[1] 60483    62
### normalization
> dim(y)
[1] 60483    62
> keep <-rowSums(cpm(y)>=1) >= 20
> y<-y[keep,]
> dim(y)
[1] 16732    62
> targets <- read.delim("factor-tcga-white-serous-62samp.txt", row.names=1)
.......
> design
   (Intercept) age60 age70 age80 treatobesity
1            1     1     0     0            1
2            1     0     1     0            1
3            1     0     1     0            0
4            1     0     0     0            1
5            1     1     0     0            1
6            1     0     1     0            0
7            1     1     0     0            0
8            1     1     0     0            1
9            1     0     1     0            0
10           1     0     1     0            1
...
61           1     0     0     0            1
62           1     1     0     0            1
> 

> setwd("/Users/linyongmao/Documents/antiIL10 monkey/dir-IL10-covid19/dir-belg-scRNAseq/ugent.covid-master")
> install.packages('knitr', dependencies = TRUE)
> library(knitr)
> install.packages('Seurat')
> library(Seurat) ####install some python 
> suppressPackageStartupMessages(library(package = "Seurat"))
> if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")

> BiocManager::install("MAST")
> library(MAST)
> suppressPackageStartupMessages(library(package = "MAST"))
> BiocManager::install("ComplexHeatmap")
> library(ComplexHeatmap)
> suppressPackageStartupMessages(library(package = "ComplexHeatmap"))
> BiocManager::install("GSEABase")
> library(GSEABase)
> suppressPackageStartupMessages(library(package = "GSEABase"))
> install.packages("tidyverse")
> library(tidyverse)
> suppressPackageStartupMessages(library(package = "tidyverse"))
> sessionInfo()

> fit <- zlm(formula = ~COVID19.status+orig.ident, sca = bAssay)
                                                                                                                                                
Done!
Warning message:
In .nextMethod(object = object, value = value) :
  Coefficients orig.identCOV029_3 are never estimible and will be dropped.


   primerid   contrast          `Pr(>Chisq)` logFC        adjp
   <chr>      <fct>                    <dbl> <dbl>       <dbl>
 1 ACADVL     COVID19.statusPOS     2.15e- 9  1.80 0.0000131  
 2 AL450405.1 COVID19.statusPOS     3.83e-11 -2.38 0.000000465
 3 CHCHD1     COVID19.statusPOS     2.44e- 8  1.74 0.0000687  
 4 HLA-A      COVID19.statusPOS     3.48e-10 28.2  0.00000264 
 5 HSP90B1    COVID19.statusPOS     3.41e- 9 48.9  0.0000173  
 6 HSPA5      COVID19.statusPOS     2.56e- 9 13.9  0.0000141  
 7 IFI6       COVID19.statusPOS     2.49e- 8  5.61 0.0000687  
 8 IGHGP      COVID19.statusPOS     2.37e- 8 -6.78 0.0000687  
 9 ITM2C      COVID19.statusPOS     5.58e- 9 10.7  0.0000242  
10 LMAN1      COVID19.statusPOS     5.10e- 9  7.66 0.0000238  

> top50 <- top_n(top, n = 98765, wt = -adjp)
> write.table(top50, "diff2-1.txt", sep="\t")
mv -i diff2-1.txt belg-scrna-bcell-T1.diff2-1.txt 
cat belg-scrna-bcell-T1.diff2-1.txt  | awk 'BEGIN {FS = "\t"; OFS = "\t"} $5 != "NA" {print $2,$5, $1, $3, $4, $6}' > temp-diff2-1
vi temp-diff2-1
bash   /Users/linyongmao/Documents/dir-cancer-endometrial/script-preRank-genes temp-diff2-1 > temp-1
mv -i temp-1 belg-scrna-bcell-T1.diff2-1.rnk

####scRNA-seq T1 T2 time effect
> str(seuratComb)
Formal class 'Seurat' [package "Seurat"] with 12 slots
  ..@ assays      :List of 2
  .. ..$ RNA:Formal class 'Assay' [package "Seurat"] with 8 slots
  .. .. .. ..@ counts       :Formal class 'dgCMatrix' [package "Matrix"] with 6 slots
  .. .. .. .. .. ..@ i       : int [1:389097309] 39 62 68 88 107 109 122 138 139 140 ...
  .. .. .. .. .. ..@ p       : int [1:201010] 0 3640 6872 11572 15524 21956 24812 28239 29306 30392 ...
  .. .. .. .. .. ..@ Dim     : int [1:2] 60688 201009
  .. .. .. .. .. ..@ Dimnames:List of 2
  .. .. .. .. .. .. ..$ : chr [1:60688] "GRCh38.99-------------DDX11L1" "GRCh38.99-------------WASH7P" "GRCh38.99-------------MIR6859-1" "GRCh38.99-------------MIR1302-2HG" ...
  .. .. .. .. .. .. ..$ : chr [1:201009] "COV001_AAACCCAAGACATCCT-1" "COV001_AAACCCAAGACCTCCG-1" "COV001_AAACCCAAGCACTCGC-1" "COV001_AAACCCACACAAGCCC-1" ...
  .. .. .. .. .. ..@ x       : num [1:389097309] 1 1 4 1 1 1 1 1 1 3 ...
  .. .. .. .. .. ..@ factors : list()
  .. .. .. ..@ data         :Formal class 'dgCMatrix' [package "Matrix"] with 6 slots
  .. .. .. .. .. ..@ i       : int [1:389097309] 39 62 68 88 107 109 122 138 139 140 ...
  .. .. .. .. .. ..@ p       : int [1:201010] 0 3640 6872 11572 15524 21956 24812 28239 29306 30392 ...
  .. .. .. .. .. ..@ Dim     : int [1:2] 60688 201009
  .. .. .. .. .. ..@ Dimnames:List of 2
  .. .. .. .. .. .. ..$ : chr [1:60688] "GRCh38.99-------------DDX11L1" "GRCh38.99-------------WASH7P" "GRCh38.99-------------MIR6859-1" "GRCh38.99-------------MIR1302-2HG" ...
  .. .. .. .. .. .. ..$ : chr [1:201009] "COV001_AAACCCAAGACATCCT-1" "COV001_AAACCCAAGACCTCCG-1" "COV001_AAACCCAAGCACTCGC-1" "COV001_AAACCCACACAAGCCC-1" ...
  .. .. .. .. .. ..@ x       : num [1:389097309] 0.607 0.607 1.468 0.607 0.607 ...
  .. .. .. .. .. ..@ factors : list()
  .. .. .. ..@ scale.data   : num [1:2000, 1:201009] -0.1503 -0.229 -0.0714 -0.2222 -0.019 ...
  .. .. .. .. ..- attr(*, "dimnames")=List of 2
  .. .. .. .. .. ..$ : chr [1:2000] "GRCh38.99-------------MTND1P23" "GRCh38.99-------------MTND2P28" "GRCh38.99-------------MTCO1P12" "GRCh38.99-------------HES4" ...
  .. .. .. .. .. ..$ : chr [1:201009] "COV001_AAACCCAAGACATCCT-1" "COV001_AAACCCAAGACCTCCG-1" "COV001_AAACCCAAGCACTCGC-1" "COV001_AAACCCACACAAGCCC-1" ...
  .. .. .. ..@ key          : chr "rna_"
  .. .. .. ..@ assay.orig   : NULL
  .. .. .. ..@ var.features : chr [1:2000] "GRCh38.99-------------IGLC3" "GRCh38.99-------------IGHM" "GRCh38.99-------------IGHA1" "GRCh38.99-------------IGHG1" ...
  .. .. .. ..@ meta.features:'data.frame':	60688 obs. of  5 variables:
  .. .. .. .. ..$ vst.mean                 : num [1:60688] 0 0 0 0 0 ...
  .. .. .. .. ..$ vst.variance             : num [1:60688] 0 0 0 0 0 ...
  .. .. .. .. ..$ vst.variance.expected    : num [1:60688] 0 0 0 0 0 ...
  .. .. .. .. ..$ vst.variance.standardized: num [1:60688] 0 0 0 0 0 ...
  .. .. .. .. ..$ vst.variable             : logi [1:60688] FALSE FALSE FALSE FALSE FALSE FALSE ...
  .. .. .. ..@ misc         : NULL
  .. ..$ ADT:Formal class 'Assay' [package "Seurat"] with 8 slots
  .. .. .. ..@ counts       :Formal class 'dgCMatrix' [package "Matrix"] with 6 slots
  .. .. .. .. .. ..@ i       : int [1:13569513] 1 5 6 14 17 19 21 23 27 31 ...
  .. .. .. .. .. ..@ p       : int [1:201010] 0 0 0 0 0 0 0 0 0 0 ...
  .. .. .. .. .. ..@ Dim     : int [1:2] 300 201009
  .. .. .. .. .. ..@ Dimnames:List of 2
  .. .. .. .. .. .. ..$ : chr [1:300] "CD80" "CD86" "CD274" "CD273" ...
  .. .. .. .. .. .. ..$ : chr [1:201009] "COV001_AAACCCAAGACATCCT-1" "COV001_AAACCCAAGACCTCCG-1" "COV001_AAACCCAAGCACTCGC-1" "COV001_AAACCCACACAAGCCC-1" ...
  .. .. .. .. .. ..@ x       : num [1:13569513] 3 1 2 1 22 2 1 14 1 5 ...
  .. .. .. .. .. ..@ factors : list()
  .. .. .. ..@ data         :Formal class 'dgCMatrix' [package "Matrix"] with 6 slots
  .. .. .. .. .. ..@ i       : int [1:13569513] 1 5 6 14 17 19 21 23 27 31 ...
  .. .. .. .. .. ..@ p       : int [1:201010] 0 0 0 0 0 0 0 0 0 0 ...
  .. .. .. .. .. ..@ Dim     : int [1:2] 300 201009
  .. .. .. .. .. ..@ Dimnames:List of 2
  .. .. .. .. .. .. ..$ : chr [1:300] "CD80" "CD86" "CD274" "CD273" ...
  .. .. .. .. .. .. ..$ : chr [1:201009] "COV001_AAACCCAAGACATCCT-1" "COV001_AAACCCAAGACCTCCG-1" "COV001_AAACCCAAGCACTCGC-1" "COV001_AAACCCACACAAGCCC-1" ...
  .. .. .. .. .. ..@ x       : num [1:13569513] 3 1 2 1 22 2 1 14 1 5 ...
  .. .. .. .. .. ..@ factors : list()
  .. .. .. ..@ scale.data   : num[0 , 0 ] 
  .. .. .. ..@ key          : chr "ADT_"
  .. .. .. ..@ assay.orig   : NULL
  .. .. .. ..@ var.features : logi(0) 
  .. .. .. ..@ meta.features:'data.frame':	300 obs. of  0 variables
  .. .. .. ..@ misc         : NULL
  ..@ meta.data   :'data.frame':	201009 obs. of  30 variables:
  .. ..$ orig.ident               : chr [1:201009] "COV001" "COV001" "COV001" "COV001" ...
  .. ..$ nCount_RNA               : num [1:201009] 11980 9912 17403 12512 29394 ...
  .. ..$ nFeature_RNA             : int [1:201009] 3640 3232 4700 3952 6432 2856 3427 1067 1086 3791 ...
  .. ..$ nCount_ADT               : num [1:201009] NA NA NA NA NA NA NA NA NA NA ...
  .. ..$ nFeature_ADT             : int [1:201009] NA NA NA NA NA NA NA NA NA NA ...
  .. ..$ nCount_HTO               : num [1:201009] NA NA NA NA NA NA NA NA NA NA ...
  .. ..$ nFeature_HTO             : int [1:201009] NA NA NA NA NA NA NA NA NA NA ...
  .. ..$ HTO_maxID                : chr [1:201009] NA NA NA NA ...
  .. ..$ HTO_secondID             : chr [1:201009] NA NA NA NA ...
  .. ..$ HTO_margin               : num [1:201009] NA NA NA NA NA NA NA NA NA NA ...
  .. ..$ HTO_classification       : chr [1:201009] NA NA NA NA ...
  .. ..$ HTO_classification.global: chr [1:201009] NA NA NA NA ...
  .. ..$ hash.ID                  : chr [1:201009] NA NA NA NA ...
  .. ..$ Library.ID               : chr [1:201009] "COV001" "COV001" "COV001" "COV001" ...
  .. ..$ Patient.number           : chr [1:201009] "COVIM54" "COVIM54" "COVIM54" "COVIM54" ...
  .. ..$ Sample..type             : chr [1:201009] "BAL" "BAL" "BAL" "BAL" ...
  .. ..$ COVID19.status           : chr [1:201009] "POS" "POS" "POS" "POS" ...
  .. ..$ Sampling                 : POSIXct[1:201009], format: "2020-04-08" "2020-04-08" "2020-04-08" "2020-04-08" ...
  .. ..$ RBC.contamination        : chr [1:201009] "Hi" "Hi" "Hi" "Hi" ...
  .. ..$ Remarks                  : chr [1:201009] "Red pellet upon arrival" "Red pellet upon arrival" "Red pellet upon arrival" "Red pellet upon arrival" ...
  .. ..$ Granulocyte..            : num [1:201009] NA NA NA NA NA NA NA NA NA NA ...
  .. ..$ Alternative.diagnosis    : chr [1:201009] NA NA NA NA ...
  .. ..$ Comorbidities            : chr [1:201009] "multiple sclerosis" "multiple sclerosis" "multiple sclerosis" "multiple sclerosis" ...
  .. ..$ CITEseq                  : chr [1:201009] "No" "No" "No" "No" ...
  .. ..$ Sort                     : chr [1:201009] "Yes" "Yes" "Yes" "Yes" ...
  .. ..$ CD45.enrichment          : chr [1:201009] "No" "No" "No" "No" ...
  .. ..$ Fresh.Frozen             : chr [1:201009] "Fresh" "Fresh" "Fresh" "Fresh" ...
  .. ..$ HTO                      : chr [1:201009] "/" "/" "/" "/" ...
  .. ..$ singler.subset           : chr [1:201009] "Macrophage" "T_cells" "Macrophage" "Macrophage" ...
  .. ..$ singler.subset2          : chr [1:201009] "Macrophage:monocyte-derived:M-CSF/IFNg" "T_cell:gamma-delta" "Macrophage:monocyte-derived:M-CSF/IFNg" "Macrophage:monocyte-derived:M-CSF/IFNg" ...
  ..@ active.assay: chr "RNA"
  ..@ active.ident: Factor w/ 20 levels "COV001","COV002",..: 1 1 1 1 1 1 1 1 1 1 ...
  .. ..- attr(*, "names")= chr [1:201009] "COV001_AAACCCAAGACATCCT-1" "COV001_AAACCCAAGACCTCCG-1" "COV001_AAACCCAAGCACTCGC-1" "COV001_AAACCCACACAAGCCC-1" ...
  ..@ graphs      : list()
  ..@ neighbors   : list()
  ..@ reductions  :List of 2
  .. ..$ pca :Formal class 'DimReduc' [package "Seurat"] with 9 slots
  .. .. .. ..@ cell.embeddings           : num [1:201009, 1:50] 1.1851 0.0496 0.7136 1.2482 1.2421 ...
  .. .. .. .. ..- attr(*, "dimnames")=List of 2
  .. .. .. .. .. ..$ : chr [1:201009] "COV001_AAACCCAAGACATCCT-1" "COV001_AAACCCAAGACCTCCG-1" "COV001_AAACCCAAGCACTCGC-1" "COV001_AAACCCACACAAGCCC-1" ...
  .. .. .. .. .. ..$ : chr [1:50] "PC_1" "PC_2" "PC_3" "PC_4" ...
  .. .. .. ..@ feature.loadings          : num [1:2000, 1:50] 0.002682 0.002627 0.002984 0.000752 0.003792 ...
  .. .. .. .. ..- attr(*, "dimnames")=List of 2
  .. .. .. .. .. ..$ : chr [1:2000] "GRCh38.99-------------IGLC3" "GRCh38.99-------------IGHM" "GRCh38.99-------------IGHA1" "GRCh38.99-------------IGHG1" ...
  .. .. .. .. .. ..$ : chr [1:50] "PC_1" "PC_2" "PC_3" "PC_4" ...
  .. .. .. ..@ feature.loadings.projected: num[0 , 0 ] 
  .. .. .. ..@ assay.used                : chr "RNA"
  .. .. .. ..@ global                    : logi FALSE
  .. .. .. ..@ stdev                     : num [1:50] 12.57 7.81 5.7 5.31 4.81 ...
  .. .. .. ..@ key                       : chr "PC_"
  .. .. .. ..@ jackstraw                 :Formal class 'JackStrawData' [package "Seurat"] with 4 slots
  .. .. .. .. .. ..@ empirical.p.values     : num[0 , 0 ] 
  .. .. .. .. .. ..@ fake.reduction.scores  : num[0 , 0 ] 
  .. .. .. .. .. ..@ empirical.p.values.full: num[0 , 0 ] 
  .. .. .. .. .. ..@ overall.p.values       : num[0 , 0 ] 
  .. .. .. ..@ misc                      :List of 1
  .. .. .. .. ..$ total.variance: num 1056
  .. ..$ umap:Formal class 'DimReduc' [package "Seurat"] with 9 slots
  .. .. .. ..@ cell.embeddings           : num [1:201009, 1:2] -12.1 4.8 -12.1 -10.7 -10.8 ...
  .. .. .. .. ..- attr(*, "scaled:center")= num [1:2] -0.0125 -0.2442
  .. .. .. .. ..- attr(*, "dimnames")=List of 2
  .. .. .. .. .. ..$ : chr [1:201009] "COV001_AAACCCAAGACATCCT-1" "COV001_AAACCCAAGACCTCCG-1" "COV001_AAACCCAAGCACTCGC-1" "COV001_AAACCCACACAAGCCC-1" ...
  .. .. .. .. .. ..$ : chr [1:2] "UMAP_1" "UMAP_2"
  .. .. .. ..@ feature.loadings          : num[0 , 0 ] 
  .. .. .. ..@ feature.loadings.projected: num[0 , 0 ] 
  .. .. .. ..@ assay.used                : chr "RNA"
  .. .. .. ..@ global                    : logi TRUE
  .. .. .. ..@ stdev                     : num(0) 
  .. .. .. ..@ key                       : chr "UMAP_"
  .. .. .. ..@ jackstraw                 :Formal class 'JackStrawData' [package "Seurat"] with 4 slots
  .. .. .. .. .. ..@ empirical.p.values     : num[0 , 0 ] 
  .. .. .. .. .. ..@ fake.reduction.scores  : num[0 , 0 ] 
  .. .. .. .. .. ..@ empirical.p.values.full: num[0 , 0 ] 
  .. .. .. .. .. ..@ overall.p.values       : num[0 , 0 ] 
  .. .. .. ..@ misc                      : list()
  ..@ project.name: chr "SeuratProject"
  ..@ misc        : list()
  ..@ version     :Classes 'package_version', 'numeric_version'  hidden list of 1
  .. ..$ : int [1:3] 3 1 5
  ..@ commands    :List of 5
  .. ..$ NormalizeData.RNA       :Formal class 'SeuratCommand' [package "Seurat"] with 5 slots
  .. .. .. ..@ name       : chr "NormalizeData.RNA"
  .. .. .. ..@ time.stamp : POSIXct[1:1], format: "2020-06-03 14:47:56"
  .. .. .. ..@ assay.used : chr "RNA"
  .. .. .. ..@ call.string: chr [1:2] "NormalizeData(seuratComb, normalization.method = \"LogNormalize\", " "    scale.factor = 10000)"
  .. .. .. ..@ params     :List of 5
  .. .. .. .. ..$ assay               : chr "RNA"
  .. .. .. .. ..$ normalization.method: chr "LogNormalize"
  .. .. .. .. ..$ scale.factor        : num 10000
  .. .. .. .. ..$ margin              : num 1
  .. .. .. .. ..$ verbose             : logi TRUE
  .. ..$ FindVariableFeatures.RNA:Formal class 'SeuratCommand' [package "Seurat"] with 5 slots
  .. .. .. ..@ name       : chr "FindVariableFeatures.RNA"
  .. .. .. ..@ time.stamp : POSIXct[1:1], format: "2020-06-03 14:51:22"
  .. .. .. ..@ assay.used : chr "RNA"
  .. .. .. ..@ call.string: chr "FindVariableFeatures(object = seuratComb)"
  .. .. .. ..@ params     :List of 12
  .. .. .. .. ..$ assay              : chr "RNA"
  .. .. .. .. ..$ selection.method   : chr "vst"
  .. .. .. .. ..$ loess.span         : num 0.3
  .. .. .. .. ..$ clip.max           : chr "auto"
  .. .. .. .. ..$ mean.function      :function (mat, display_progress)  
  .. .. .. .. ..$ dispersion.function:function (mat, display_progress)  
  .. .. .. .. ..$ num.bin            : num 20
  .. .. .. .. ..$ binning.method     : chr "equal_width"
  .. .. .. .. ..$ nfeatures          : num 2000
  .. .. .. .. ..$ mean.cutoff        : num [1:2] 0.1 8
  .. .. .. .. ..$ dispersion.cutoff  : num [1:2] 1 Inf
  .. .. .. .. ..$ verbose            : logi TRUE
  .. ..$ ScaleData.RNA           :Formal class 'SeuratCommand' [package "Seurat"] with 5 slots
  .. .. .. ..@ name       : chr "ScaleData.RNA"
  .. .. .. ..@ time.stamp : POSIXct[1:1], format: "2020-06-03 14:52:33"
  .. .. .. ..@ assay.used : chr "RNA"
  .. .. .. ..@ call.string: chr "ScaleData(seuratComb, verbose = FALSE)"
  .. .. .. ..@ params     :List of 10
  .. .. .. .. ..$ features          : chr [1:2000] "GRCh38.99-------------IGLC3" "GRCh38.99-------------IGHM" "GRCh38.99-------------IGHA1" "GRCh38.99-------------IGHG1" ...
  .. .. .. .. ..$ assay             : chr "RNA"
  .. .. .. .. ..$ model.use         : chr "linear"
  .. .. .. .. ..$ use.umi           : logi FALSE
  .. .. .. .. ..$ do.scale          : logi TRUE
  .. .. .. .. ..$ do.center         : logi TRUE
  .. .. .. .. ..$ scale.max         : num 10
  .. .. .. .. ..$ block.size        : num 1000
  .. .. .. .. ..$ min.cells.to.block: num 3000
  .. .. .. .. ..$ verbose           : logi FALSE
  .. ..$ RunPCA.RNA              :Formal class 'SeuratCommand' [package "Seurat"] with 5 slots
  .. .. .. ..@ name       : chr "RunPCA.RNA"
  .. .. .. ..@ time.stamp : POSIXct[1:1], format: "2020-06-03 14:55:57"
  .. .. .. ..@ assay.used : chr "RNA"
  .. .. .. ..@ call.string: chr "RunPCA(seuratComb, verbose = FALSE)"
  .. .. .. ..@ params     :List of 10
  .. .. .. .. ..$ assay          : chr "RNA"
  .. .. .. .. ..$ npcs           : num 50
  .. .. .. .. ..$ rev.pca        : logi FALSE
  .. .. .. .. ..$ weight.by.var  : logi TRUE
  .. .. .. .. ..$ verbose        : logi FALSE
  .. .. .. .. ..$ ndims.print    : int [1:5] 1 2 3 4 5
  .. .. .. .. ..$ nfeatures.print: num 30
  .. .. .. .. ..$ reduction.name : chr "pca"
  .. .. .. .. ..$ reduction.key  : chr "PC_"
  .. .. .. .. ..$ seed.use       : num 42
  .. ..$ RunUMAP.RNA.pca         :Formal class 'SeuratCommand' [package "Seurat"] with 5 slots
  .. .. .. ..@ name       : chr "RunUMAP.RNA.pca"
  .. .. .. ..@ time.stamp : POSIXct[1:1], format: "2020-06-03 15:01:29"
  .. .. .. ..@ assay.used : chr "RNA"
  .. .. .. ..@ call.string: chr "RunUMAP(seuratComb, dims = 1:10, verbose = FALSE)"
  .. .. .. ..@ params     :List of 20
  .. .. .. .. ..$ dims                : int [1:10] 1 2 3 4 5 6 7 8 9 10
  .. .. .. .. ..$ reduction           : chr "pca"
  .. .. .. .. ..$ assay               : chr "RNA"
  .. .. .. .. ..$ umap.method         : chr "uwot"
  .. .. .. .. ..$ n.neighbors         : int 30
  .. .. .. .. ..$ n.components        : int 2
  .. .. .. .. ..$ metric              : chr "cosine"
  .. .. .. .. ..$ learning.rate       : num 1
  .. .. .. .. ..$ min.dist            : num 0.3
  .. .. .. .. ..$ spread              : num 1
  .. .. .. .. ..$ set.op.mix.ratio    : num 1
  .. .. .. .. ..$ local.connectivity  : int 1
  .. .. .. .. ..$ repulsion.strength  : num 1
  .. .. .. .. ..$ negative.sample.rate: int 5
  .. .. .. .. ..$ uwot.sgd            : logi FALSE
  .. .. .. .. ..$ seed.use            : int 42
  .. .. .. .. ..$ angular.rp.forest   : logi FALSE
  .. .. .. .. ..$ verbose             : logi FALSE
  .. .. .. .. ..$ reduction.name      : chr "umap"
  .. .. .. .. ..$ reduction.key       : chr "UMAP_"
  ..@ tools       : list()
> str(seuratComb)
Formal class 'Seurat' [package "Seurat"] with 12 slots
  ..@ assays      :List of 2
  .. ..$ RNA:Formal class 'Assay' [package "Seurat"] with 8 slots
  .. .. .. ..@ counts       :Formal class 'dgCMatrix' [package "Matrix"] with 6 slots
  .. .. .. .. .. ..@ i       : int [1:389097309] 39 62 68 88 107 109 122 138 139 140 ...
  .. .. .. .. .. ..@ p       : int [1:201010] 0 3640 6872 11572 15524 21956 24812 28239 29306 30392 ...
  .. .. .. .. .. ..@ Dim     : int [1:2] 60688 201009
  .. .. .. .. .. ..@ Dimnames:List of 2
  .. .. .. .. .. .. ..$ : chr [1:60688] "GRCh38.99-------------DDX11L1" "GRCh38.99-------------WASH7P" "GRCh38.99-------------MIR6859-1" "GRCh38.99-------------MIR1302-2HG" ...
  .. .. .. .. .. .. ..$ : chr [1:201009] "COV001_AAACCCAAGACATCCT-1" "COV001_AAACCCAAGACCTCCG-1" "COV001_AAACCCAAGCACTCGC-1" "COV001_AAACCCACACAAGCCC-1" ...
  .. .. .. .. .. ..@ x       : num [1:389097309] 1 1 4 1 1 1 1 1 1 3 ...
  .. .. .. .. .. ..@ factors : list()
  .. .. .. ..@ data         :Formal class 'dgCMatrix' [package "Matrix"] with 6 slots
  .. .. .. .. .. ..@ i       : int [1:389097309] 39 62 68 88 107 109 122 138 139 140 ...
  .. .. .. .. .. ..@ p       : int [1:201010] 0 3640 6872 11572 15524 21956 24812 28239 29306 30392 ...
  .. .. .. .. .. ..@ Dim     : int [1:2] 60688 201009
  .. .. .. .. .. ..@ Dimnames:List of 2
  .. .. .. .. .. .. ..$ : chr [1:60688] "GRCh38.99-------------DDX11L1" "GRCh38.99-------------WASH7P" "GRCh38.99-------------MIR6859-1" "GRCh38.99-------------MIR1302-2HG" ...
  .. .. .. .. .. .. ..$ : chr [1:201009] "COV001_AAACCCAAGACATCCT-1" "COV001_AAACCCAAGACCTCCG-1" "COV001_AAACCCAAGCACTCGC-1" "COV001_AAACCCACACAAGCCC-1" ...
  .. .. .. .. .. ..@ x       : num [1:389097309] 0.607 0.607 1.468 0.607 0.607 ...
  .. .. .. .. .. ..@ factors : list()
  .. .. .. ..@ scale.data   : num [1:2000, 1:201009] -0.1503 -0.229 -0.0714 -0.2222 -0.019 ...
  .. .. .. .. ..- attr(*, "dimnames")=List of 2
  .. .. .. .. .. ..$ : chr [1:2000] "GRCh38.99-------------MTND1P23" "GRCh38.99-------------MTND2P28" "GRCh38.99-------------MTCO1P12" "GRCh38.99-------------HES4" ...
  .. .. .. .. .. ..$ : chr [1:201009] "COV001_AAACCCAAGACATCCT-1" "COV001_AAACCCAAGACCTCCG-1" "COV001_AAACCCAAGCACTCGC-1" "COV001_AAACCCACACAAGCCC-1" ...
  .. .. .. ..@ key          : chr "rna_"
  .. .. .. ..@ assay.orig   : NULL
  .. .. .. ..@ var.features : chr [1:2000] "GRCh38.99-------------IGLC3" "GRCh38.99-------------IGHM" "GRCh38.99-------------IGHA1" "GRCh38.99-------------IGHG1" ...
  .. .. .. ..@ meta.features:'data.frame':	60688 obs. of  5 variables:
  .. .. .. .. ..$ vst.mean                 : num [1:60688] 0 0 0 0 0 ...
  .. .. .. .. ..$ vst.variance             : num [1:60688] 0 0 0 0 0 ...
  .. .. .. .. ..$ vst.variance.expected    : num [1:60688] 0 0 0 0 0 ...
  .. .. .. .. ..$ vst.variance.standardized: num [1:60688] 0 0 0 0 0 ...
  .. .. .. .. ..$ vst.variable             : logi [1:60688] FALSE FALSE FALSE FALSE FALSE FALSE ...
  .. .. .. ..@ misc         : NULL
  .. ..$ ADT:Formal class 'Assay' [package "Seurat"] with 8 slots
  .. .. .. ..@ counts       :Formal class 'dgCMatrix' [package "Matrix"] with 6 slots
  .. .. .. .. .. ..@ i       : int [1:13569513] 1 5 6 14 17 19 21 23 27 31 ...
  .. .. .. .. .. ..@ p       : int [1:201010] 0 0 0 0 0 0 0 0 0 0 ...
  .. .. .. .. .. ..@ Dim     : int [1:2] 300 201009
  .. .. .. .. .. ..@ Dimnames:List of 2
  .. .. .. .. .. .. ..$ : chr [1:300] "CD80" "CD86" "CD274" "CD273" ...
  .. .. .. .. .. .. ..$ : chr [1:201009] "COV001_AAACCCAAGACATCCT-1" "COV001_AAACCCAAGACCTCCG-1" "COV001_AAACCCAAGCACTCGC-1" "COV001_AAACCCACACAAGCCC-1" ...
  .. .. .. .. .. ..@ x       : num [1:13569513] 3 1 2 1 22 2 1 14 1 5 ...
  .. .. .. .. .. ..@ factors : list()
  .. .. .. ..@ data         :Formal class 'dgCMatrix' [package "Matrix"] with 6 slots
  .. .. .. .. .. ..@ i       : int [1:13569513] 1 5 6 14 17 19 21 23 27 31 ...
  .. .. .. .. .. ..@ p       : int [1:201010] 0 0 0 0 0 0 0 0 0 0 ...
  .. .. .. .. .. ..@ Dim     : int [1:2] 300 201009
  .. .. .. .. .. ..@ Dimnames:List of 2
  .. .. .. .. .. .. ..$ : chr [1:300] "CD80" "CD86" "CD274" "CD273" ...
  .. .. .. .. .. .. ..$ : chr [1:201009] "COV001_AAACCCAAGACATCCT-1" "COV001_AAACCCAAGACCTCCG-1" "COV001_AAACCCAAGCACTCGC-1" "COV001_AAACCCACACAAGCCC-1" ...
  .. .. .. .. .. ..@ x       : num [1:13569513] 3 1 2 1 22 2 1 14 1 5 ...
  .. .. .. .. .. ..@ factors : list()
  .. .. .. ..@ scale.data   : num[0 , 0 ] 
  .. .. .. ..@ key          : chr "ADT_"
  .. .. .. ..@ assay.orig   : NULL
  .. .. .. ..@ var.features : logi(0) 
  .. .. .. ..@ meta.features:'data.frame':	300 obs. of  0 variables
  .. .. .. ..@ misc         : NULL
  ..@ meta.data   :'data.frame':	201009 obs. of  31 variables:
  .. ..$ orig.ident               : chr [1:201009] "COV001" "COV001" "COV001" "COV001" ...
  .. ..$ nCount_RNA               : num [1:201009] 11980 9912 17403 12512 29394 ...
  .. ..$ nFeature_RNA             : int [1:201009] 3640 3232 4700 3952 6432 2856 3427 1067 1086 3791 ...
  .. ..$ nCount_ADT               : num [1:201009] NA NA NA NA NA NA NA NA NA NA ...
  .. ..$ nFeature_ADT             : int [1:201009] NA NA NA NA NA NA NA NA NA NA ...
  .. ..$ nCount_HTO               : num [1:201009] NA NA NA NA NA NA NA NA NA NA ...
  .. ..$ nFeature_HTO             : int [1:201009] NA NA NA NA NA NA NA NA NA NA ...
  .. ..$ HTO_maxID                : chr [1:201009] NA NA NA NA ...
  .. ..$ HTO_secondID             : chr [1:201009] NA NA NA NA ...
  .. ..$ HTO_margin               : num [1:201009] NA NA NA NA NA NA NA NA NA NA ...
  .. ..$ HTO_classification       : chr [1:201009] NA NA NA NA ...
  .. ..$ HTO_classification.global: chr [1:201009] NA NA NA NA ...
  .. ..$ hash.ID                  : chr [1:201009] NA NA NA NA ...
  .. ..$ Library.ID               : chr [1:201009] "COV001" "COV001" "COV001" "COV001" ...
  .. ..$ Patient.number           : chr [1:201009] "COVIM54" "COVIM54" "COVIM54" "COVIM54" ...
  .. ..$ Sample..type             : chr [1:201009] "BAL" "BAL" "BAL" "BAL" ...
  .. ..$ COVID19.status           : chr [1:201009] "POS" "POS" "POS" "POS" ...
  .. ..$ Sampling                 : POSIXct[1:201009], format: "2020-04-08" "2020-04-08" "2020-04-08" "2020-04-08" ...
  .. ..$ RBC.contamination        : chr [1:201009] "Hi" "Hi" "Hi" "Hi" ...
  .. ..$ Remarks                  : chr [1:201009] "Red pellet upon arrival" "Red pellet upon arrival" "Red pellet upon arrival" "Red pellet upon arrival" ...
  .. ..$ Granulocyte..            : num [1:201009] NA NA NA NA NA NA NA NA NA NA ...
  .. ..$ Alternative.diagnosis    : chr [1:201009] NA NA NA NA ...
  .. ..$ Comorbidities            : chr [1:201009] "multiple sclerosis" "multiple sclerosis" "multiple sclerosis" "multiple sclerosis" ...
  .. ..$ CITEseq                  : chr [1:201009] "No" "No" "No" "No" ...
  .. ..$ Sort                     : chr [1:201009] "Yes" "Yes" "Yes" "Yes" ...
  .. ..$ CD45.enrichment          : chr [1:201009] "No" "No" "No" "No" ...
  .. ..$ Fresh.Frozen             : chr [1:201009] "Fresh" "Fresh" "Fresh" "Fresh" ...
  .. ..$ HTO                      : chr [1:201009] "/" "/" "/" "/" ...
  .. ..$ singler.subset           : chr [1:201009] "Macrophage" "T_cells" "Macrophage" "Macrophage" ...
  .. ..$ singler.subset2          : chr [1:201009] "Macrophage:monocyte-derived:M-CSF/IFNg" "T_cell:gamma-delta" "Macrophage:monocyte-derived:M-CSF/IFNg" "Macrophage:monocyte-derived:M-CSF/IFNg" ...
  .. ..$ Severity.Score.worse     : chr [1:201009] "Severe" "Severe" "Severe" "Severe" ...
  ..@ active.assay: chr "RNA"
  ..@ active.ident: Factor w/ 20 levels "COV001","COV002",..: 1 1 1 1 1 1 1 1 1 1 ...
  .. ..- attr(*, "names")= chr [1:201009] "COV001_AAACCCAAGACATCCT-1" "COV001_AAACCCAAGACCTCCG-1" "COV001_AAACCCAAGCACTCGC-1" "COV001_AAACCCACACAAGCCC-1" ...
  ..@ graphs      : list()
  ..@ neighbors   : list()
  ..@ reductions  :List of 2
  .. ..$ pca :Formal class 'DimReduc' [package "Seurat"] with 9 slots
  .. .. .. ..@ cell.embeddings           : num [1:201009, 1:50] 1.1851 0.0496 0.7136 1.2482 1.2421 ...
  .. .. .. .. ..- attr(*, "dimnames")=List of 2
  .. .. .. .. .. ..$ : chr [1:201009] "COV001_AAACCCAAGACATCCT-1" "COV001_AAACCCAAGACCTCCG-1" "COV001_AAACCCAAGCACTCGC-1" "COV001_AAACCCACACAAGCCC-1" ...
  .. .. .. .. .. ..$ : chr [1:50] "PC_1" "PC_2" "PC_3" "PC_4" ...
  .. .. .. ..@ feature.loadings          : num [1:2000, 1:50] 0.002682 0.002627 0.002984 0.000752 0.003792 ...
  .. .. .. .. ..- attr(*, "dimnames")=List of 2
  .. .. .. .. .. ..$ : chr [1:2000] "GRCh38.99-------------IGLC3" "GRCh38.99-------------IGHM" "GRCh38.99-------------IGHA1" "GRCh38.99-------------IGHG1" ...
  .. .. .. .. .. ..$ : chr [1:50] "PC_1" "PC_2" "PC_3" "PC_4" ...
  .. .. .. ..@ feature.loadings.projected: num[0 , 0 ] 
  .. .. .. ..@ assay.used                : chr "RNA"
  .. .. .. ..@ global                    : logi FALSE
  .. .. .. ..@ stdev                     : num [1:50] 12.57 7.81 5.7 5.31 4.81 ...
  .. .. .. ..@ key                       : chr "PC_"
  .. .. .. ..@ jackstraw                 :Formal class 'JackStrawData' [package "Seurat"] with 4 slots
  .. .. .. .. .. ..@ empirical.p.values     : num[0 , 0 ] 
  .. .. .. .. .. ..@ fake.reduction.scores  : num[0 , 0 ] 
  .. .. .. .. .. ..@ empirical.p.values.full: num[0 , 0 ] 
  .. .. .. .. .. ..@ overall.p.values       : num[0 , 0 ] 
  .. .. .. ..@ misc                      :List of 1
  .. .. .. .. ..$ total.variance: num 1056
  .. ..$ umap:Formal class 'DimReduc' [package "Seurat"] with 9 slots
  .. .. .. ..@ cell.embeddings           : num [1:201009, 1:2] -12.1 4.8 -12.1 -10.7 -10.8 ...
  .. .. .. .. ..- attr(*, "scaled:center")= num [1:2] -0.0125 -0.2442
  .. .. .. .. ..- attr(*, "dimnames")=List of 2
  .. .. .. .. .. ..$ : chr [1:201009] "COV001_AAACCCAAGACATCCT-1" "COV001_AAACCCAAGACCTCCG-1" "COV001_AAACCCAAGCACTCGC-1" "COV001_AAACCCACACAAGCCC-1" ...
  .. .. .. .. .. ..$ : chr [1:2] "UMAP_1" "UMAP_2"
  .. .. .. ..@ feature.loadings          : num[0 , 0 ] 
  .. .. .. ..@ feature.loadings.projected: num[0 , 0 ] 
  .. .. .. ..@ assay.used                : chr "RNA"
  .. .. .. ..@ global                    : logi TRUE
  .. .. .. ..@ stdev                     : num(0) 
  .. .. .. ..@ key                       : chr "UMAP_"
  .. .. .. ..@ jackstraw                 :Formal class 'JackStrawData' [package "Seurat"] with 4 slots
  .. .. .. .. .. ..@ empirical.p.values     : num[0 , 0 ] 
  .. .. .. .. .. ..@ fake.reduction.scores  : num[0 , 0 ] 
  .. .. .. .. .. ..@ empirical.p.values.full: num[0 , 0 ] 
  .. .. .. .. .. ..@ overall.p.values       : num[0 , 0 ] 
  .. .. .. ..@ misc                      : list()
  ..@ project.name: chr "SeuratProject"
  ..@ misc        : list()
  ..@ version     :Classes 'package_version', 'numeric_version'  hidden list of 1
  .. ..$ : int [1:3] 3 1 5
  ..@ commands    :List of 5
  .. ..$ NormalizeData.RNA       :Formal class 'SeuratCommand' [package "Seurat"] with 5 slots
  .. .. .. ..@ name       : chr "NormalizeData.RNA"
  .. .. .. ..@ time.stamp : POSIXct[1:1], format: "2020-06-03 14:47:56"
  .. .. .. ..@ assay.used : chr "RNA"
  .. .. .. ..@ call.string: chr [1:2] "NormalizeData(seuratComb, normalization.method = \"LogNormalize\", " "    scale.factor = 10000)"
  .. .. .. ..@ params     :List of 5
  .. .. .. .. ..$ assay               : chr "RNA"
  .. .. .. .. ..$ normalization.method: chr "LogNormalize"
  .. .. .. .. ..$ scale.factor        : num 10000
  .. .. .. .. ..$ margin              : num 1
  .. .. .. .. ..$ verbose             : logi TRUE
  .. ..$ FindVariableFeatures.RNA:Formal class 'SeuratCommand' [package "Seurat"] with 5 slots
  .. .. .. ..@ name       : chr "FindVariableFeatures.RNA"
  .. .. .. ..@ time.stamp : POSIXct[1:1], format: "2020-06-03 14:51:22"
  .. .. .. ..@ assay.used : chr "RNA"
  .. .. .. ..@ call.string: chr "FindVariableFeatures(object = seuratComb)"
  .. .. .. ..@ params     :List of 12
  .. .. .. .. ..$ assay              : chr "RNA"
  .. .. .. .. ..$ selection.method   : chr "vst"
  .. .. .. .. ..$ loess.span         : num 0.3
  .. .. .. .. ..$ clip.max           : chr "auto"
  .. .. .. .. ..$ mean.function      :function (mat, display_progress)  
  .. .. .. .. ..$ dispersion.function:function (mat, display_progress)  
  .. .. .. .. ..$ num.bin            : num 20
  .. .. .. .. ..$ binning.method     : chr "equal_width"
  .. .. .. .. ..$ nfeatures          : num 2000
  .. .. .. .. ..$ mean.cutoff        : num [1:2] 0.1 8
  .. .. .. .. ..$ dispersion.cutoff  : num [1:2] 1 Inf
  .. .. .. .. ..$ verbose            : logi TRUE
  .. ..$ ScaleData.RNA           :Formal class 'SeuratCommand' [package "Seurat"] with 5 slots
  .. .. .. ..@ name       : chr "ScaleData.RNA"
  .. .. .. ..@ time.stamp : POSIXct[1:1], format: "2020-06-03 14:52:33"
  .. .. .. ..@ assay.used : chr "RNA"
  .. .. .. ..@ call.string: chr "ScaleData(seuratComb, verbose = FALSE)"
  .. .. .. ..@ params     :List of 10
  .. .. .. .. ..$ features          : chr [1:2000] "GRCh38.99-------------IGLC3" "GRCh38.99-------------IGHM" "GRCh38.99-------------IGHA1" "GRCh38.99-------------IGHG1" ...
  .. .. .. .. ..$ assay             : chr "RNA"
  .. .. .. .. ..$ model.use         : chr "linear"
  .. .. .. .. ..$ use.umi           : logi FALSE
  .. .. .. .. ..$ do.scale          : logi TRUE
  .. .. .. .. ..$ do.center         : logi TRUE
  .. .. .. .. ..$ scale.max         : num 10
  .. .. .. .. ..$ block.size        : num 1000
  .. .. .. .. ..$ min.cells.to.block: num 3000
  .. .. .. .. ..$ verbose           : logi FALSE
  .. ..$ RunPCA.RNA              :Formal class 'SeuratCommand' [package "Seurat"] with 5 slots
  .. .. .. ..@ name       : chr "RunPCA.RNA"
  .. .. .. ..@ time.stamp : POSIXct[1:1], format: "2020-06-03 14:55:57"
  .. .. .. ..@ assay.used : chr "RNA"
  .. .. .. ..@ call.string: chr "RunPCA(seuratComb, verbose = FALSE)"
  .. .. .. ..@ params     :List of 10
  .. .. .. .. ..$ assay          : chr "RNA"
  .. .. .. .. ..$ npcs           : num 50
  .. .. .. .. ..$ rev.pca        : logi FALSE
  .. .. .. .. ..$ weight.by.var  : logi TRUE
  .. .. .. .. ..$ verbose        : logi FALSE
  .. .. .. .. ..$ ndims.print    : int [1:5] 1 2 3 4 5
  .. .. .. .. ..$ nfeatures.print: num 30
  .. .. .. .. ..$ reduction.name : chr "pca"
  .. .. .. .. ..$ reduction.key  : chr "PC_"
  .. .. .. .. ..$ seed.use       : num 42
  .. ..$ RunUMAP.RNA.pca         :Formal class 'SeuratCommand' [package "Seurat"] with 5 slots
  .. .. .. ..@ name       : chr "RunUMAP.RNA.pca"
  .. .. .. ..@ time.stamp : POSIXct[1:1], format: "2020-06-03 15:01:29"
  .. .. .. ..@ assay.used : chr "RNA"
  .. .. .. ..@ call.string: chr "RunUMAP(seuratComb, dims = 1:10, verbose = FALSE)"
  .. .. .. ..@ params     :List of 20
  .. .. .. .. ..$ dims                : int [1:10] 1 2 3 4 5 6 7 8 9 10
  .. .. .. .. ..$ reduction           : chr "pca"
  .. .. .. .. ..$ assay               : chr "RNA"
  .. .. .. .. ..$ umap.method         : chr "uwot"
  .. .. .. .. ..$ n.neighbors         : int 30
  .. .. .. .. ..$ n.components        : int 2
  .. .. .. .. ..$ metric              : chr "cosine"
  .. .. .. .. ..$ learning.rate       : num 1
  .. .. .. .. ..$ min.dist            : num 0.3
  .. .. .. .. ..$ spread              : num 1
  .. .. .. .. ..$ set.op.mix.ratio    : num 1
  .. .. .. .. ..$ local.connectivity  : int 1
  .. .. .. .. ..$ repulsion.strength  : num 1
  .. .. .. .. ..$ negative.sample.rate: int 5
  .. .. .. .. ..$ uwot.sgd            : logi FALSE
  .. .. .. .. ..$ seed.use            : int 42
  .. .. .. .. ..$ angular.rp.forest   : logi FALSE
  .. .. .. .. ..$ verbose             : logi FALSE
  .. .. .. .. ..$ reduction.name      : chr "umap"
  .. .. .. .. ..$ reduction.key       : chr "UMAP_"
  ..@ tools       : list()

Coefficients orig.identCOV029_3 are never estimible and will be dropped.
# A tibble: 10 x 5
   primerid   contrast          `Pr(>Chisq)`  logFC     adjp
   <chr>      <fct>                    <dbl>  <dbl>    <dbl>
 1 AL450405.1 COVID19.statusPOS     1.09e-16 -1.08  6.21e-12
 2 HLA-DRB1   COVID19.statusPOS     1.42e-15 -1.88  2.88e-11
 3 LTB        COVID19.statusPOS     2.20e-14 -1.61  2.23e-10
 4 OXR1       COVID19.statusPOS     3.72e-13 -0.434 2.43e- 9
 5 RPL11      COVID19.statusPOS     1.15e-13 -1.08  9.93e-10
 6 RPL13      COVID19.statusPOS     4.00e-13 -1.15  2.43e- 9
 7 RPL13A     COVID19.statusPOS     2.29e-13 -1.12  1.74e- 9
 8 RPS14      COVID19.statusPOS     1.76e-14 -1.14  2.13e-10
 9 RPS4Y1     COVID19.statusPOS     2.05e-16 -1.50  6.21e-12
10 XIST       COVID19.statusPOS     5.37e-15  0.925 8.14e-11

> write.table(bComb@meta.data, "bComb-meta.data.xls", sep="\t")

bComb <- seuratComb[, seuratComb$singler.subset %in% "B_cell" &
                        seuratComb$Sample..type %in% "BAL" &
                        ( seuratComb$COVID19.status == "POS" | seuratComb$COVID19.status == "NEG")]

> dim(bComb)
[1] 60688  3677

bComb <- seuratComb[, seuratComb$singler.subset %in% "B_cell" &
                        seuratComb$Sample..type %in% "BAL" &
                      seuratComb$COVID19.status == "POS" &
                      (seuratComb$Severity.Score.worse == "Critical" | seuratComb$Severity.Score.worse == "Moderate")]
> dim(bComb)
[1] 60688  1565

fit <- zlm(formula  = ~Severity.Score.worse+orig.ident,
	   sca      = bAssay,
	   parallel = FALSE)
###  Coefficients orig.identCOV024 are never estimible and will be dropped.
summaryCond <- MAST::summary(fit, doLRT = "Severity.Score.worseModerate")
top <- summaryCond$datatable %>%
  filter(contrast %in% "Severity.Score.worseModerate" &
	   # hurdle test
	   component %in% c("H", "logFC")) %>% 
  pivot_longer(cols = c("Pr(>Chisq)", "coef")) %>%
  filter(!is.na(value)) %>%
  select(primerid, contrast, name, value) %>%
  pivot_wider(names_from = name, values_from = value) %>%
  dplyr::rename(`logFC` = `coef`) %>%
  mutate(adjp = p.adjust(`Pr(>Chisq)`, method = "BH"))

top50 <- top_n(top, n = 50, wt = -adjp)
mat <- as.matrix(bComb$RNA@data[top50$primerid, ])
rownames(mat) <- gsub(pattern = ".+---", replacement = "", rownames(mat))
ha <- HeatmapAnnotation(ident = bComb@meta.data$orig.ident)
Heatmap(matrix = mat,
	column_split = bComb@meta.data$Severity.Score.worse,
	top_annotation = ha,
	row_split = c("DN", "UP")[(top50$logFC > 0) + 1],
	show_column_names = FALSE,
	name = "log2(counts)")
####
# A tibble: 10 x 5
   primerid contrast                     `Pr(>Chisq)` logFC      adjp
   <chr>    <fct>                               <dbl> <dbl>     <dbl>
 1 BST2     Severity.Score.worseModerate    2.20e-153  1.68 2.23e-149
 2 IRF7     Severity.Score.worseModerate    7.40e-147  1.89 4.99e-143
 3 ISG15    Severity.Score.worseModerate    2.54e-165  2.42 3.86e-161
 4 ISG20    Severity.Score.worseModerate    9.69e-139  1.92 5.88e-135
 5 MT-ATP6  Severity.Score.worseModerate    9.16e-177 -2.28 1.85e-172
 6 MT-CO3   Severity.Score.worseModerate    2.03e-156 -2.02 2.46e-152
 7 MT-ND2   Severity.Score.worseModerate    9.53e-153 -1.92 8.26e-149
 8 MT-ND3   Severity.Score.worseModerate    5.75e-245 -2.47 3.49e-240
 9 MT-ND4   Severity.Score.worseModerate    1.41e-150 -1.94 1.07e-146
10 MX1      Severity.Score.worseModerate    4.86e-191  2.16 1.48e-186
##Coefficients orig.identCOV025 are never estimible and will be dropped.

bComb <- seuratComb[, seuratComb$singler.subset %in% "B_cell" &
                        seuratComb$Sample..type %in% "BAL" &
                      seuratComb$COVID19.status == "POS" &
                      (seuratComb$Severity.Score.worse == "Severe" | seuratComb$Severity.Score.worse == "Moderate")]
> dim(bComb)
[1] 60688  1455
summaryCond <- MAST::summary(fit, doLRT = "Severity.Score.worseSevere")
top <- summaryCond$datatable %>%
  filter(contrast %in% "Severity.Score.worseSevere" &
           # hurdle test
           component %in% c("H", "logFC")) %>%
  pivot_longer(cols = c("Pr(>Chisq)", "coef")) %>%
  filter(!is.na(value)) %>%
  select(primerid, contrast, name, value) %>%
  pivot_wider(names_from = name, values_from = value) %>%
  dplyr::rename(`logFC` = `coef`) %>%
  mutate(adjp = p.adjust(`Pr(>Chisq)`, method = "BH"))

# A tibble: 10 x 5
   primerid contrast                   `Pr(>Chisq)`  logFC     adjp
   <chr>    <fct>                             <dbl>  <dbl>    <dbl>
 1 ATP5ME   Severity.Score.worseSevere     1.19e-59  1.03  1.20e-55
 2 HLA-C    Severity.Score.worseSevere     1.81e-47 -0.802 1.22e-43
 3 HLA-DQA2 Severity.Score.worseSevere     4.48e-45  0.495 2.72e-41
 4 ISG15    Severity.Score.worseSevere     4.57e-66 -1.96  9.24e-62
 5 MT-ND3   Severity.Score.worseSevere     1.73e-57  1.40  1.50e-53
 6 MT-TP    Severity.Score.worseSevere     2.86e-64  0.902 4.33e-60
 7 MX1      Severity.Score.worseSevere     2.28e-54 -1.39  1.73e-50
 8 RPS29    Severity.Score.worseSevere     1.75e-77  1.09  5.31e-73
 9 RPS4Y1   Severity.Score.worseSevere     9.63e-60 NA     1.17e-55
10 XIST     Severity.Score.worseSevere     7.33e-86 NA     4.45e-81

bComb <- seuratComb[, seuratComb$singler.subset %in% "B_cell" &
                        seuratComb$Sample..type %in% "BAL" &
                      seuratComb$COVID19.status == "POS" &
                      (seuratComb$Severity.Score.worse == "Severe" | seuratComb$Severity.Score.worse == "Critical")]
### Coefficients orig.identCOV024 are never estimible and will be dropped.

# A tibble: 10 x 5
   primerid contrast                   `Pr(>Chisq)` logFC     adjp
   <chr>    <fct>                             <dbl> <dbl>    <dbl>
 1 DERL3    Severity.Score.worseSevere     3.50e-34  1.22 3.54e-30
 2 HSP90B1  Severity.Score.worseSevere     2.14e-35  1.93 3.25e-31
 3 ITM2C    Severity.Score.worseSevere     3.63e-44  1.42 1.10e-39
 4 JCHAIN   Severity.Score.worseSevere     2.08e-56  3.54 1.26e-51
 5 MT-ATP6  Severity.Score.worseSevere     5.62e-34 -1.60 4.87e-30
 6 MT-ND1   Severity.Score.worseSevere     2.22e-31 -1.29 1.35e-27
 7 MT-ND2   Severity.Score.worseSevere     1.94e-32 -1.49 1.31e-28
 8 MZB1     Severity.Score.worseSevere     1.24e-34  2.07 1.50e-30
 9 PPIB     Severity.Score.worseSevere     6.45e-34  1.60 4.89e-30
10 SSR4     Severity.Score.worseSevere     1.42e-36  1.72 2.87e-32
> write.table(bComb$RNA@data, file = "temp.txt", sep = "\t") ### 0.5G size

###because HID people most have B_cell:Memory
###still pos vs. neg, because HID are negatives
bComb <- seuratComb[, seuratComb$singler.subset2 == "B_cell:Memory" &
                        seuratComb$Sample..type %in% "BAL" &
                        ( seuratComb$COVID19.status == "POS" | grepl(pattern = "HID", seuratComb$Patient.number))]

> dim(bComb)
[1] 60688   408
fit <- zlm(formula  = ~Severity.Score.worse+orig.ident,
           sca      = bAssay,
           parallel = FALSE)
###  Coefficients orig.identCOV012 are never estimible and will be dropped.

###Coefficients orig.identCOV017 are never estimible and will be dropped
$ cat bComb-meta.data.BAL.BcellMem.xls | cut -f 2,16,31,17,18 | sort | uniq -c
  31 "COV001"	"COVIM54"	"BAL"	"POS"	"B_cell:Memory"
 157 "COV002"	"COVIM54"	"BAL"	"POS"	"B_cell:Memory"
  54 "COV012"	"COVIM077"	"BAL"	"POS"	"B_cell:Memory"
  37 "COV013"	"COVIM081"	"BAL"	"POS"	"B_cell:Memory"
  67 "COV015"	"COVIM086"	"BAL"	"POS"	"B_cell:Memory"
   6 "COV016"	"HID-0334"	"BAL"	"NEG"	"B_cell:Memory"
  16 "COV017"	"HID-0335"	"BAL"	"NEG"	"B_cell:Memory"
  40 "COV024"	"COVIM068"	"BAL"	"POS"	"B_cell:Memory"
   1 "orig.ident"	"Patient.number"	"Sample..type"	"COVID19.status"	"singler.subset2"

bComb <- seuratComb[, seuratComb$singler.subset %in% "B_cell" &
			seuratComb$Sample..type %in% "PBMC" &
			grepl(pattern = "T1", seuratComb$Patient.number) & 
                      seuratComb$COVID19.status == "POS" &
                      (seuratComb$Severity.Score.worse == "Critical" | seuratComb$Severity.Score.worse == "Moderate") ]
> dim(bComb)
[1] 60688   294
   primerid contrast                     `Pr(>Chisq)`  logFC     adjp
   <chr>    <fct>                               <dbl>  <dbl>    <dbl>
 1 EIF1AY   Severity.Score.worseModerate     1.88e- 6  0.449 1.90e- 2
 2 HLA-DQA2 Severity.Score.worseModerate     3.17e-11 NA     6.42e- 7
 3 HLA-DRB1 Severity.Score.worseModerate     3.37e- 7  0.918 5.12e- 3
 4 HLA-DRB6 Severity.Score.worseModerate     4.55e- 7 -0.637 5.52e- 3
 5 HLA-E    Severity.Score.worseModerate     2.54e- 5  0.320 1.54e- 1
 6 LMAN1    Severity.Score.worseModerate     2.21e- 5 -0.533 1.49e- 1
 7 MT-ND4   Severity.Score.worseModerate     1.67e- 5 -0.768 1.27e- 1
 8 RPS4X    Severity.Score.worseModerate     7.18e- 6 -0.519 6.22e- 2
 9 RPS4Y1   Severity.Score.worseModerate     4.03e-13  1.39  1.22e- 8
10 XIST     Severity.Score.worseModerate     1.08e-15 NA     6.54e-11

bComb <- seuratComb[, seuratComb$singler.subset %in% "B_cell" &
                        seuratComb$Sample..type %in% "PBMC" &
                        grepl(pattern = "T1", seuratComb$Patient.number) &
                      seuratComb$COVID19.status == "POS" &
                      (seuratComb$Severity.Score.worse == "Severe" | seuratComb$Severity.Score.worse == "Moderate") ]
> dim(bComb)
[1] 60688   241
##
   primerid contrast                   `Pr(>Chisq)`  logFC     adjp
   <chr>    <fct>                             <dbl>  <dbl>    <dbl>
 1 BANK1    Severity.Score.worseSevere     5.36e-33 -1.52  3.62e-29
 2 CD37     Severity.Score.worseSevere     7.26e-44 -1.95  4.41e-39
 3 CD74     Severity.Score.worseSevere     3.61e-37 -2.12  5.47e-33
 4 CD79B    Severity.Score.worseSevere     5.44e-36 -1.40  5.50e-32
 5 HLA-DQB1 Severity.Score.worseSevere     3.38e-36 -1.69  4.10e-32
 6 HLA-DRA  Severity.Score.worseSevere     5.84e-43 -2.99  1.77e-38
 7 HLA-DRB1 Severity.Score.worseSevere     1.11e-39 -2.13  2.25e-35
 8 P2RY10   Severity.Score.worseSevere     3.17e-32 -0.564 1.92e-28
 9 SNX2     Severity.Score.worseSevere     8.66e-34 -0.798 6.57e-30
10 TXNIP    Severity.Score.worseSevere     1.63e-35 -1.89  1.42e-31

bComb <- seuratComb[, seuratComb$singler.subset %in% "B_cell" &
                        seuratComb$Sample..type %in% "PBMC" &
                        grepl(pattern = "T1", seuratComb$Patient.number) &
                      seuratComb$COVID19.status == "POS" &
                      (seuratComb$Severity.Score.worse == "Severe" | seuratComb$Severity.Score.worse == "Critical") ]
> dim(bComb)
[1] 60688   447
   primerid contrast                   `Pr(>Chisq)` logFC     adjp
   <chr>    <fct>                             <dbl> <dbl>    <dbl>
 1 CD37     Severity.Score.worseSevere     3.19e-40 -1.43 3.22e-36
 2 CD74     Severity.Score.worseSevere     6.50e-37 -1.51 4.93e-33
 3 HLA-DPB1 Severity.Score.worseSevere     8.57e-37 -1.56 5.78e-33
 4 HLA-DRA  Severity.Score.worseSevere     4.30e-49 -2.34 1.30e-44
 5 HLA-DRB1 Severity.Score.worseSevere     2.63e-45 -1.47 4.00e-41
 6 HLA-DRB5 Severity.Score.worseSevere     6.77e-39 -1.30 5.87e-35
 7 LTB      Severity.Score.worseSevere     1.36e-41 -1.57 1.65e-37
 8 RPS4Y1   Severity.Score.worseSevere     6.52e-47 NA    1.32e-42
 9 TXNIP    Severity.Score.worseSevere     3.15e-36 -1.52 1.91e-32
10 XIST     Severity.Score.worseSevere     1.02e-64  1.02 6.19e-60

##### anchor, clustering 
load(file = file.path(workDir, "output/ugent.seurat.RData"))
bComb <- seuratComb[, seuratComb$singler.subset %in% "B_cell" &
                         seuratComb$Sample..type %in% "BAL" &
                         ( seuratComb$COVID19.status == "POS")]
dim(bComb)
#[1] 60688  2116

bComb <- seuratComb[, seuratComb$singler.subset %in% "B_cell" &
                        seuratComb$Sample..type %in% "PBMC" &
                        grepl(pattern = "T1", seuratComb$Patient.number) &
                      seuratComb$COVID19.status == "POS" ]
dim(bComb)
###[1] 60688   491

bComb <- seuratComb[, seuratComb$Sample..type %in% "BAL" &
                         ( seuratComb$COVID19.status == "POS")]
dim(bComb)
## 60688 75016

bComb <- AddMetaData(object   = bComb,
		     metadata = colnames(bComb),
		     col.name = "wellKey")
bAssay <- FromMatrix(exprsArray = list(et = bComb$RNA@data),
		     cData      = bComb@meta.data)
cl <- read.table("BAL_barcodes_meta.subset.POS.bcellsONLY.txt", header = T, sep = "\t") ###6437 cells
for ( i in rownames(cl)) {bComb$HTO_classification[i] = cl[i,1] }
 dim(bComb)
# [1] 60688 75016
unique(bComb$HTO_classification)
## [1] NA                        "Plasma cells - terminal" "Plasma cells - active"   "Plasma cell"            
## [5] "Plasma cells - prolif"   "B cells"     
bCombBcell <- bComb[, grepl(pattern = "cell", bComb$HTO_classification)]
dim(bCombBcell)
#[1] 60688  1542 cells with b cell annot from Ruth

bCombBcell$RNA@counts <- rbind(bCombBcell$RNA@counts, bCombBcell$ADT@counts)
bCombBcell$RNA@data   <- rbind(bCombBcell$RNA@data, bCombBcell$ADT@data)
 dim(bCombBcell)
####[1] 60988   491
######pancreas.list[[i]] <- NormalizeData(pancreas.list[[i]], verbose = FALSE)
#bCombBcell <- NormalizeData(bCombBcell, verbose = T)
#######pancreas.list[[i]] <- FindVariableFeatures(pancreas.list[[i]], selection.method = "vst", 
#######        nfeatures = 2000, verbose = FALSE)
#bCombBcell <- FindVariableFeatures(bCombBcell, selection.method = "vst", nfeatures = 2000, verbose = T)
#######seuratPBMC <- subset(seuratComb, ident = "PBMC") 
##Idents(bCombBcell) <- "Sample..type"
splitLS <- SplitObject(object = bCombBcell, split.by = "orig.ident")
splitLS <- lapply(X = splitLS, FUN = function(x) {
    x <- NormalizeData(x, verbose = T)
    x <- FindVariableFeatures(x, selection.method = "vst", nfeatures = 2000, verbose = T)
})
intFeats <- SelectIntegrationFeatures(splitLS)
intFeats <- setdiff(intFeats, row.names(bCombBcell@assays$ADT))
###2000 -> 1899
splitAnchors <- FindIntegrationAnchors(object.list = splitLS,
                                        dims = 1:30, k.filter = 40, anchor.features = c(intFeats, row.names(bCombBcell@assays$ADT)))
### k.filter = 35 starting from Belgium based b cell annotations in BAL, Retained 115 anchors
#splitAnchors <- FindIntegrationAnchors(object.list = splitLS,
                                        dims = 1:30, k.filter = 100)

#####pancreas.integrated <- IntegrateData(anchorset = pancreas.anchors, dims = 1:30)
pancreas.integrated <- IntegrateData(anchorset = splitAnchors, dims = 1:30)
pancreas.integrated <- ScaleData(pancreas.integrated, verbose = T)
pancreas.integrated <- RunPCA(pancreas.integrated, npcs = 30, verbose = T)
pancreas.integrated <- RunUMAP(pancreas.integrated, reduction = "pca", dims = 1:30)
DimPlot(pancreas.integrated, reduction = "umap", group.by = "Severity.Score.worse")
DimPlot(pancreas.integrated, reduction = "umap", group.by = "orig.ident")
###pbmc <- pancreas.integrated
pancreas.integrated <- FindNeighbors(object = pancreas.integrated)
pancreas.integrated <- FindClusters(object = pancreas.integrated)
##pbmc <- RunTSNE(object = pbmc)
###DimPlot(object = pbmc, reduction = "tsne")
###DimPlot(object = pbmc, reduction = "tsne", label = TRUE, repel = T) + NoLegend()
DimPlot(object = pancreas.integrated, reduction = "umap", label = TRUE, repel = T ) + NoLegend()
#pancreas.integrated.markers <- FindAllMarkers(pancreas.integrated, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 0.25)
pancreas.integrated.markers <- FindAllMarkers(pancreas.integrated)
write.table(pancreas.integrated.markers, file = "temp.xls", sep = "\t")
write.table(pancreas.integrated@reductions$umap@cell.embeddings, file = "temp.xls", sep = "\t")
 write.table(pancreas.integrated$seurat_clusters, file = "temp.clust.xls", sep = "\t")
 write.table(pancreas.integrated$Severity.Score.worse, file = "temp.sev.xls", sep = "\t")
$ paste temp.xls temp.sev.xls temp.clust.xls | awk 'BEGIN {FS = "\t"} $1 == $4 && $1 == $6'|wc -l
$ paste temp.xls temp.sev.xls temp.clust.xls | cut -f 1,2,3,5,7 > out

DimPlot(pancreas.integrated, reduction = "umap", split.by = "Severity.Score.worse", group.by = "seurat_clusters")

####singleR()
pancreas.integrated.geneOnly <- pancreas.integrated[grepl(pattern = "GRCh38",rownames(pancreas.integrated)),  ]
scaledMat <- as.matrix(pancreas.integrated.geneOnly$integrated@data)
rownames(scaledMat) <- gsub(pattern = ".+---", replacement = "",
			    rownames(scaledMat))
hpca <- HumanPrimaryCellAtlasData()
 hpca <- hpca[, hpca@colData$label.main %in%
		 c("B_cell", "DC", "Monocyte", "Neutrophils",
		   "NK_cell", "Platelets", "T_cells")]
predSubset <- SingleR(test    = scaledMat,
		      ref     = hpca,
                      labels  = hpca$label.main)
pancreas.integrated.geneOnly <- AddMetaData(object = pancreas.integrated.geneOnly,metadata = predSubset$labels,
			col.name = "singler.subset.bcell") ###~800 / 1542 cells annot as b cells
hpca <- HumanPrimaryCellAtlasData()
hpca_b <- subset(hpca, select = label.main == "B_cell")
predSubset <- SingleR(test    = scaledMat,
                      ref     = hpca_b,
                      labels  = hpca_b$label.fine)
pancreas.integrated.geneOnly <- AddMetaData(object = pancreas.integrated.geneOnly,metadata = predSubset$labels,
                        col.name = "singler.subset.bcell.fine")

intComb <- IntegrateData(anchorset = splitAnchors,
			  dims      = 1:10,
			  features.to.integrate = rownames(seuratObj))

bComb <- ScaleData(bComb, verbose = T)
bComb <- RunPCA(bComb, verbose = T)
bComb <- RunUMAP(bComb, dims = 1:6, verbose = T)
#Warning: The default method for RunUMAP has changed from calling Python UMAP via reticulate to the R-native UWOT using the cosine metric
#To use Python UMAP via reticulate, set umap.method to 'umap-learn' and metric to 'correlation'
#This message will be shown once per session
DimPlot(bComb, reduction = "umap", group.by = "orig.ident")

cl <- read.table("bal.bcell.covidPos.clust.xls", header = T, sep = "\t")
for ( i in rownames(cl)) {bComb$HTO_classification[i] = cl[i,1] }


file:///Users/linyongmao/gsea_home/output/may05/belg-scrna-bcell-T1.LM22.GseaPreranked.1593535796028/index.html
/Users/linyongmao/gsea_home/output/may05/
/Users/linyongmao/Documents/antiIL10 monkey/dir-IL10-covid19
cat belg-scrna-bcell-T1*/gsea_report_for*.xls | awk 'BEGIN {FS = "\t"; OFS = "\t"} $8 < 0.05' > temp.xls
cat b-cell-scRNA-pathways-overlap-nomP | awk 'BEGIN {FS = "\t"; OFS = "\t"} $1 > $2 && log($7) < log(0.005)' | grep -iv Ma-HALLMARK > temp.xls

cat b-cell-scRNA-logCount-T1-posVsNeg-PBMC-pathways-overlap | awk 'BEGIN {FS = "\t"; OFS = "\t"} NR > 1 && $1 != $2 && $3/$4 >= 0.25 && $3/$5 >= 0.25 ' > temp
###common / uniq pathways mod by covid-19 status
bash tem-script-generate-chea-target-file-LEG-pathway-2 | cut -f 1-5 | sort | uniq > temp-bal-posVSneg-allPaths
temp-bal-critVmod-allPaths
temp-bal-servVcrit-allPaths 
temp-bal-servVmod-allPaths
paste temp-bal-posVSneg-allPaths temp-bal-servVmod-allPaths temp-bal-critVmod-allPaths temp-bal-servVcrit-allPaths > temp.xls

Looks like a plasmablast/plasma wll signature. 
cat temp-apop-genes | while read g; do grep -iw $g belg-scrna-bcell-Time-effect.diff2-1.txt; done | awk 'BEGIN {FS = "\t"; OFS = "\t"} log($6) < log(0.05)' | cut -f 2 | sed 's/"GRCh38.99-----*//' | sed 's/"//'

$ bash script-make-gmt-IGgenes >> "/Users/linyongmao/Documents/antiIL10 monkey/anti-IL10-IL10stim-gene-signature.gmt"
grep -iw IGHV3-30 temp.bComb@data.txt > temp
head -1 temp.bComb@data.txt >> temp
vi temp
"/Users/linyongmao/Documents/antiIL10 monkey/dir-IL10-covid19/table-transpose" temp temp.tp
vi  temp.tp   ###:1, $ s/_.*"/"/
sort -t '	' +1 -2 temp.tp > temp.tp.sorted
cat bComb-meta.data.xls | cut -f 2,16,17,18 | sort | uniq > temp-samp-status
join -t '	' -1 2  -2 1 temp.tp.sorted temp-samp-status > temp.xls

####pathway level all genes 
#####avg expression score
vi temp-plasm-all-genes.txt
bash script-pathway-exprAvg-scRNA-pbmc-bcell-T1 > out.xls
cat out.xls | awk 'BEGIN {FS = "\t"; OFS = "\t"} NF > 100' > temp.plasm.pathway.avgExp.txt
"/Users/linyongmao/Documents/antiIL10 monkey/dir-IL10-covid19/table-transpose" temp.plasm.pathway.avgExp.txt temp.plasm.pathway.avgExp.tp.txt
sort temp.plasm.pathway.avgExp.tp.txt > out
mv out temp.plasm.pathway.avgExp.tp.txt 
sed 's/\.1"/-1"/' temp.plasm.pathway.avgExp.tp.txt > out
mv out temp.plasm.pathway.avgExp.tp.txt
cut -f 1-2 bComb-meta.pbmc.bcell.T1.xls | sort > temp-cell-patient
join -t '	' -1 1 -2 1 temp-cell-patient temp.plasm.pathway.avgExp.tp.txt | cut -f 2-1234567 > out
bash script-allCellsOfApatient-2 | sort > temp.patient-pathwayAvg
cut -f 2,18,32 bComb-meta.pbmc.bcell.T1.xls | sort | uniq > temp-patient-status-severe
join -t '	' -1 1 -2 1 temp-patient-status-severe temp.patient-pathwayAvg

###############cell type freq.#####
cat  seuratComb-meta.data.complete.8-3.xls | grep -w PBMC | grep "\"POS\"" | grep "_T1" |  cut -f 2,16,17,18,30,32 | sort | uniq -c > temp.txt
###197 "COV003"	"COVIM54_T1"	"PBMC"	"POS"	"B_cell"	"Severe"
cat temp.txt | sed 's/^  *//' | sed 's/  */	/' > out
mv out temp.txt
vi temp.txt ###rm leading space, and spaces following count #
cat temp.txt | cut -f 2,3 | sort | uniq -c
bash script-celltype-freq-1 > temp-celltype-freq.xls



ls $dir | grep -i bal  | grep -i belg | grep -vw c7 > temp-dir
vi temp-dir
bash tem-script-generate-chea-target-file-LEG-pathway-2 | cut -f 1,2,4,6 > temp-bal-covidstatus-pathway.xls
vi temp-interest-paths ###9 pathways
cat temp-interest-paths | while read p; do grep -iw "$p" temp-bal-covidstatus-pathway.xls; done > temp-bal-covidstatus-pathway.selPaths
wc -l temp-bal-covidstatus-pathway.selPaths
###      27 temp-bal-covidstatus-pathway.selPaths
cat temp-*-covidstatus-pathway.selPaths > temp.covidstatus-pathway.selPaths.54rows
bash ./script-preRank-genes-signed-FDR temp.covidstatus-pathway.selPaths.54rows | cut -f 1,2,5 > temp.covidstatus-pathway.selPaths.54rows.signedFDR
vi temp.covidstatus-pathway.selPaths.54rows.signedFDR #1, $ s/\./_/ (two times)   :1, $ s/_[a-zA-Z]*Pos[^^I]*//   :1, $ s/\.[a-zA-Z]*Pos[^^I]*//
cut -f 1 temp.covidstatus-pathway.selPaths.54rows.signedFDR | sort | uniq -c
bash ./script-make-table-path-condition-p-value | uniq > bcell-PBMC.T1.BAL.9paths.txt

####pathways C7, covid de novo cluster
bash tem-script-generate-chea-target-file-LEG-pathway-2 | cut -f 1 | grep -i bcell | sort | uniq   > temp-c7-uniq-paths
##$8(FDR) < 0.05 && $6 (NES) > 1.6 , only up-reg in severe cases, 74 paths
bash tem-script-generate-chea-target-file-LEG-pathway-3 > temp-all-paths ###extra 1st colum for the contrast (CvM)
bash tem-scr-1 > tem-covid-c7-table-0 ### each path in temp-c7-uniq-paths, their behaviors in all contrasts
cat  tem-covid-c7-table-0 | cut -f 2 | uniq -c | awk '$1 == 3' | wc -l ###74 paths appear in all 3 contrasts
cat  tem-covid-c7-table-0 | grep diff2-1.CvM.Cpos > temp-1
cat  tem-covid-c7-table-0 | grep diff2-1.SvM.Spos > temp-2
cat  tem-covid-c7-table-0 | grep diff2-1.CvS.Cpos > temp-3
paste temp-[123] |awk 'BEGIN {FS = "\t"; OFS = "\t"}  $2 == $8 && $2 == $14' | wc -l ###74
paste temp-[123] |awk 'BEGIN {FS = "\t"; OFS = "\t"}  $2 == $8 && $2 == $14' > tem-covid-c7-table-1.txt
vi tem-covid-c7-table-2.txt #### pathway	NES	NOM p-val	NES	NOM p-val	NES	NOM p-val
bash tem-script-preRank-genes-signed-FDR tem-covid-c7-table-2.txt > tem-covid-c7-table-3.txt
cp -i tem-covid-c7-table-3.txt tem-covid-c7-table-4.txt
vi  tem-covid-c7-table-4.txt ###remove something like Bcell vs monocyte
> data <- read.table(file ="tem-covid-c7-table-4.txt", header = T, sep = "\t", row.names= 1)
> mat <- as.matrix(data)
> Heatmap(matrix = mat,name = "signed log10 (p-value)", row_names_gp = gpar(fontsize = 7), row_names_max_width = max_text_width(
+         rownames(mat), 
+         gp = gpar(fontsize = 10)
+     ))

###ComplexHeatmap####
$ cat temp | while read g; do grep -i "\-\-\-$g\"" belg-scrna-bcell-PBMC.T1.diff2-1.servVmod.servPos.txt; done | cut -f 2 > temp.txt
$ vi temp.txt
$ head temp.txt
"primerid"	"logFC"
"GRCh38.99-------------ACTB"	0.523520958290465
"GRCh38.99-------------ARHGDIB"	-0.179007969731024
"GRCh38.99-------------ATP5MF"	-0.491569689860415

genes <- read.delim("temp.txt", header = T)
top50 = genes
mat <- as.matrix(bComb$RNA@data[genes$primerid, ])
rownames(mat) <- gsub(pattern = ".+---", replacement = "", rownames(mat))
ha <- HeatmapAnnotation(ident = bComb@meta.data$orig.ident, tissue = bComb@meta.data$Sample..type )
Heatmap(matrix = mat,
        column_split = bComb@meta.data$Severity.Score.worse,
        top_annotation = ha,
        show_column_names = FALSE,
        name = "log2(counts)", row_names_gp = gpar(fontsize = 9))

ha <- HeatmapAnnotation(ident = bComb@meta.data$orig.ident, tissue = bComb@meta.data$Sample..type, col = list(ident = c("COV030_2" = "red", "COV030_1" = "green", "COV032_4" = "blue", "COV032_3" = "yellow")) )
ha <- HeatmapAnnotation(ident = bComb@meta.data$orig.ident, status = bComb@meta.data$COVID19.status, tissue = bComb@meta.data$Sample..type )
Heatmap(matrix = mat,
        column_split = bComb@meta.data$Severity.Score.worse,
        top_annotation = ha,
        row_split = c("critical UP", "critical down")[(top50$logFC > 0) + 1],
        show_column_names = FALSE,
        name = "log2(counts)", row_names_gp = gpar(fontsize = 9))


bash gsea-cli.sh GSEAPreranked -gmx "/Users/linyongmao/Documents/dir-gene-set-database/c5.all.v7.1.symbols.gmt"   -collapse No_Collapse -mode Max_probe -norm meandiv  -nperm 1000 -rnk "/Users/linyongmao/Documents/antiIL10 monkey/dir-IL10-covid19/dir-belg-scRNAseq/ugent.covid-master/run/bal.bcell.startBelg.cluster4.diff2-1.CvM.Cpos.rnk"  -rpt_label gseareport -create_svgs false -include_only_symbols true   -make_sets true -plot_top_x 1234567 -rnd_seed 1234 -set_max 1500 -set_min 5 -zip_report false -out "/Users/linyongmao/Documents/antiIL10 monkey/dir-IL10-covid19/dir-belg-scRNAseq/ugent.covid-master/advanced"

###mod pathway network by overlapping
cut -f 1 bal.bcell.startBelg.cluster4.diff2-1.CvM.Cpos.rnk | awk '{print toupper($1)}' | sort | uniq > genome
cp -i  genome genes-20656.txt
temp-pax5-bach2.gmt from TRANSFAC-tf.gmt
rm temp-lead-genes.*.xls chea-TF-*.targets.xls
cp ../chea-TF-BACH2.targets.xls temp-lead-genes.BACH2.xls 
cp ../chea-TF-PAX5.targets.xls temp-lead-genes.PAX5.xls
cp ../chea-TF-BACH2.targets.xls ./
cp ../chea-TF-PAX5.targets.xls ./
bash script-generate-chea-target-file-LEG-pathway-2-fornetwork
bash "/Users/linyongmao/Documents/antiIL10 monkey/dir-IL10-covid19/script-TF-targets-enrich" > temp-1110
mv -i temp-1110 bal.bcell.startBelg.cluster4.CvM.Cpos.pos.net
cat  bal.bcell.startBelg.cluster4.CvM.Cpos.pos.net | awk 'BEGIN {FS = "\t"; OFS = "\t"} $1 < $2 ' > bal.bcell.startBelg.cluster4.CvM.Cpos.pos.net.rmDupEdges
vi bal.bcell.startBelg.cluster4.CvM.Cpos.pos.net.rmDupEdges ###add header
bash "/Users/linyongmao/Documents//antiIL10 monkey/dir-TF-db/script-hyperG-test-2-R" bal.bcell.startBelg.cluster4.CvM.Cpos.pos.net.rmDupEdges > temp-r-input
Rscript temp-r-input > temp-r-res
cat temp-r-res | awk '{print $2}' > bal.bcell.startBelg.cluster4.CvM.Cpos.pos.net.rmDupEdges.p-value
vi bal.bcell.startBelg.cluster4.CvM.Cpos.pos.net.rmDupEdges.p-value
> 10/2 * 177
[1] 885
paste bal.bcell.startBelg.cluster4.CvM.Cpos.pos.net.rmDupEdges bal.bcell.startBelg.cluster4.CvM.Cpos.pos.net.rmDupEdges.p-value | awk 'BEGIN {FS = "\t"; OFS = "\t"} $7 < 5e-135' > bal.bcell.startBelg.cluster4.CvM.Cpos.pos.net.rmDupEdges.selEdges
##893 edges, 55 nodes only
cat  bal.bcell.startBelg.cluster4.CvM.Cpos.pos.net.rmDupEdges | awk 'BEGIN {FS = "\t"; OFS = "\t"} NR > 1 && $3 / $4 > 0.25 && $3 / $5 > 0.25' > bal.bcell.startBelg.cluster4.CvM.Cpos.pos.net.rmDupEdges.2660edges
###145 nodes
bal.bcell.startBelg.cluster4.CvM.Cpos.pos.net.rmDupEdges.2660edges.145nodes
cat  bal.bcell.startBelg.cluster4.CvM.Cpos.pos.net.rmDupEdges | awk 'BEGIN {FS = "\t"; OFS = "\t"} NR > 1 && $3 / $4 > 0.25 && $3 / $5 > 0.25 {print $1, $2,2 * $3 / ($4 + $5)}' > bal.bcell.startBelg.cluster4.CvM.Cpos.pos.net.rmDupEdges.2660edges.net

bash script-count-DEGs-per-clust > out
vi out ###rm space in the file
cat out | cut -f 2,4,7,9,12,14 | uniq > temp.txt
cat out | cut -f 1,3,5,8,10,13,15 >> temp.txt

cat  temp.marker.clust.txt | awk 'BEGIN {FS = "\t"; OFS = "\t"} $7 == 4 && $3 > 0' | cut -f 8 | sed 's/GRCh38.99--*/gene---/' | awk 'BEGIN {FS = "\t"; OFS = ", "; ORS = ", "} {print $1}'
cat  temp.marker.clust.txt | awk 'BEGIN {FS = "\t"; OFS = "\t"} $7 == 4 && $3 < 0' | cut -f 8 | sed 's/GRCh38.99--*//' | sort | uniq > temp-lead-genes.clust4.neg.markers.xls
paste  clust4.neg.markers.overlap.genesets clust4.neg.markers.overlap.genesets.q-value  clust4.neg.markers.overlap.genesets.p-value | awk 'BEGIN {FS = "\t"; OFS = "\t"} $7 < 0.05'  | wc -l
      19
bash script-TF-targets-enrich-overlapGenes > clust4.neg.markers.overlap.genesets.overlapgenes

bash script-overlap-leg-freq ../advanced/m1.txt | awk '$1 > 5'  | cut -f 2  | grep -v "not exist" > temp-gene-names
vi  temp-gene-names
genes <- read.delim("temp-gene-names", header = T)
top50 = genes
mat <- as.matrix(bCombBcell$RNA@data[genes$primerid, ])
rownames(mat) <- gsub(pattern = ".+---", replacement = "", rownames(mat))
colorList <- list(ident = c("COV012" = "blue", "COV013" = "brown", "COV015" = "cyan", "COV024" = "green"), sev = c("Moderate" = "blue", "Critical" = "grey"))
ha <- HeatmapAnnotation(sev = bCombBcell@meta.data$Severity.Score.worse, ident = bCombBcell@meta.data$orig.ident)
Heatmap(matrix = mat,
        column_split = bCombBcell@meta.data$Severity.Score.worse,
        top_annotation = ha,
        show_column_names = FALSE,
column_order = 1:dim(mat)[2], row_order = 1:dim(mat)[1],
height = unit(6, "cm"), width= unit(8, "cm"),
col = colorList, 
        name = "log2(counts)", row_names_gp = gpar(fontsize = 7))


cat  temp-bComb-meta.data.xls  | awk 'BEGIN {FS = "\t"; OFS = "\t"} $12 != "NA"  {print $2, $16, $17, $18, $12, $32, $32}' | sort | uniq -c | sed 's/^ *//' | sed 's/  */	/' > temp.txt
bash  tem-script-celltype-freq-1    > temp.xls

bash script-gsea-cmds tem-gmt-list

paste bal.bcell.startBelg.cluster4vs0.clust4Pos.ADT.txt bal.bcell.startBelg.cluster4vs1.clust4Pos.ADT.txt bal.bcell.startBelg.cluster4vs3.clust4Pos.ADT.txt bal.bcell.startBelg.cluster4vs5.clust4Pos.ADT.txt  bal.bcell.startBelg.cluster4vs8.clust4Pos.ADT.txt bal.bcell.startBelg.cluster4vs9.clust4Pos.ADT.txt bal.bcell.startBelg.cluster4vs2.clust4Pos.ADT.txt bal.bcell.startBelg.cluster4vs6.clust4Pos.ADT.txt bal.bcell.startBelg.cluster4vs7.clust4Pos.ADT.txt > temp-plasm6-3bcell.txt

paste bal.bcell.startBelg.cluster6vs[013589].clust6Pos.ADT.txt bal.bcell.startBelg.cluster6vs[2467].clust6Pos.ADT.txt  > temp-plasm6-3bcell.txt ###no 6vs6 file
paste bal.bcell.startBelg.cluster6vs[013589].clust6Pos.txt bal.bcell.startBelg.cluster6vs[2467].clust6Pos.txt  > temp-plasm6-3bcell.txt ###no 6vs6 file


cat temp-plasm6-3bcell.txt | awk '
BEGIN {FS = "\t"; OFS = "\t"}
{
 for(i = 8; i <= NF; i = i+6)
 {
   if($2 != $i)
     print $0;
 }
}'

cat temp-plasm6-3bcell.txt | awk '
BEGIN {FS = "\t"; OFS = ""; ORS =""}
{
 print $2 ;
 for(i = 4; i <= NF; i = i+6)
 {
     print "\t" $i;
 }
 print "\n";
}'

awk '
BEGIN {FS = "\t"; OFS = ""; ORS =""}
{
 print $2 ;
 for(i = 5; i <= NF; i = i+6)
 {
     print "\t" $i;
 }
 print "\n";
}'

bash script-marker-clust4-compare-each-clust-signed-FDR | cut -f 2-22 > temp-clust4-compare-each-clust-signed-FDR.txt
bash script-marker-clust4-compare-each-clust-signed-FDR | cut -f 2-22 > temp-clust6-compare-each-clust-signed-FDR.txt

bash script-marker-clust4-compare-each-clust-avg-signedFDR | sort -t '	' +1 -2nr | head -51 | sort | cut -f 1 > temp-top-50-SP-clust6

paste bal.bcell.startBelg.cluster4vs0.clust4Pos.txt bal.bcell.startBelg.cluster4vs1.clust4Pos.txt bal.bcell.startBelg.cluster4vs3.clust4Pos.txt bal.bcell.startBelg.cluster4vs5.clust4Pos.txt  bal.bcell.startBelg.cluster4vs8.clust4Pos.txt bal.bcell.startBelg.cluster4vs9.clust4Pos.txt bal.bcell.startBelg.cluster4vs2.clust4Pos.txt bal.bcell.startBelg.cluster4vs6.clust4Pos.txt bal.bcell.startBelg.cluster4vs7.clust4Pos.txt > temp-plasm6-3bcell.txt

paste bal.bcell.startBelg.cluster4vs2.clust4Pos.ADT.txt bal.bcell.startBelg.cluster4vs6.clust4Pos.ADT.txt bal.bcell.startBelg.cluster4vs7.clust4Pos.ADT.txt > temp-3bcell.only.txt
vi temp-3bcell.FDRs.txt
####R cmds to calc avg of log10FDRs
 a <- read.delim("temp-3bcell.FDRs.txt", header = T, row.names=1)
b = a
for(i in 1:dim(b)[1])
{
 a[i, ] <- mean(log10((as.numeric(b[i,]))))
}
write.table(a[,1],file="temp-3bcell.FDRs.logAvg.txt", sep = "\t", quote = F)
paste  temp-3bcell.FDRs.txt  temp-3bcell.FDRs.logAvg.txt  | awk 'BEGIN {FS = "\t"; OFS = ""; ORS ="\n"} $6 < -1.301' | cut -f 1 > temp.genes

####Heatmap
a <- read.delim("bal.bcell.startBelg.clust4-compare-each-clust-signed-FDR.txt", header = T, row.names=1)
###clust_0	clust_1	clust_3	clust_5	clust_8	clust_9	clust_2	clust_6	clust_7
###clust_0      clust_1 clust_3 clust_5 clust_8 clust_9 clust_2 clust_4 clust_7

genes <- read.delim("temp.genes", header = T)
mat <- as.matrix(a[genes$gene,])
ha <- HeatmapAnnotation(sev = c("mix", "mix", "moderate", "mix", "mix", "mix", "moderate", "mix", "severe"), type=c("plasma", "plasma","plasma","plasma","plasma","plasma", "B cell", "B cell", "B cell"), col = list(sev = c("mix" = "white", "moderate" = "blue", "severe" = "orange"), type=c("plasma" = "green", "B cell" = "yellow")))
Heatmap(matrix = mat, name = "signed logFDR", column_names_side = "top",  row_names_gp = gpar(fontsize = 8), top_annotation = ha, column_order = 1:9, clustering_distance_rows = "pearson", clustering_method_rows = "centroid")

a1 <- c("CD371", "CD64", "CD33", "CD172a", "CD206", "CD305", "Mac2", "IgG", "CD123", "CD155")

a2 <- c("CD11b-mh", "Folate", "CD112", "CD93")
a3 <- c("CD45RA", "CD71", "CD27-A0191", "CD27-A0154", "CD39", "CD48")
a4 <- c("GRCh38.99-------------MZB1", "GRCh38.99-------------TNFSF13B", "GRCh38.99-------------XBP1", "GRCh38.99-------------IGHM")
####anchoring, integrating, find clusters first
VlnPlot(bCombBcell.integrated, features = c(a3), slot = "data", pt.size = 0.05, group.by = "seurat_clusters", ncol=3)

paste bal.bcell.startBelg.cluster4vs2.clust4Pos.txt bal.bcell.startBelg.cluster4vs6.clust4Pos.txt bal.bcell.startBelg.cluster4vs7.clust4Pos.txt > temp-3bcell.only.txt
#### check same gene name across a line
####temp-3bcell.FDRs.txt
#### temp-3bcell.FDRs.logAvg.txt 
vi  script-marker-FC-p-q
bash script-marker-FC-p-q > temp.txt
paste  temp-3bcell.FDRs.txt  temp-3bcell.FDRs.logAvg.txt  | awk 'BEGIN {FS = "\t"; OFS = ""; ORS ="\n"} $6 < -7' | wc -l
     576
 paste  temp-3bcell.FDRs.txt  temp-3bcell.FDRs.logAvg.txt  | awk 'BEGIN {FS = "\t"; OFS = ""; ORS ="\n"} $6 < -1.301' | cut -f 5,6 |sed 's/GRCh38.99-------------//' |sort > temp
    5302 temp
###join -t '  ' -1 1 -2 1  TF-1961genes-GO:0003700.txt.TFonly.sorted temp |  sort -t '        ' +1 -2n | head -50 | cut -f 1 > temp.TF.50genes
   RELB	-6.53834472490422
bash tem-script-2
cat chea-TF-KEGG_B_CELL_RECEPTOR_SIGNALING_PATHWAY.targets.xls
bash script-marker-clust4-compare-each-clust-signed-FDR | cut -f 2-22 > bal.bcell.startBelg.clust4-compare-each-clust-signed-FDR.allGenes.txt

paste  temp-3bcell.FDRs.txt  temp-3bcell.FDRs.logAvg.txt  | awk 'BEGIN {FS = "\t"; OFS = ""; ORS ="\n"} $6 < -1.301/3' | cut -f 1,6 | sed 's/GRCh38.99-------------//' |sort > temp
####temp with avg FDR < -1.301/3
join -t '  ' -1 1 -2 1  temp-cyto-sorted temp | sort -t '  ' +1 -2n | head -50 | cut -f 1 > temp-Cytokines-top50.genes
temp-Cytokines-top50.genes
temp-Cytokines-recept-top50.genes
temp-Chemokines-top18.genes
temp-Chemokines-Receptors-top50.genes ####less than 50 genes
temp-Chemokines-combined-34.genes
temp-Chemokines-combined-34.genes.2 (31 genes)

cut -f 2 Cytokine_Receptors.txt | sort | uniq > temp-cyto-sorted

> a <- read.delim("bal.bcell.startBelg.clust4-compare-each-clust-signed-FDR.allGenes.txt", row.names=1)
> dim(a)
[1] 60688     9

cat bal.bcell.startBelg.cluster4vs0.clust4Pos.txt  | awk 'BEGIN {FS = "\t"; OFS = "\t"} $5 != "NA" {print $2,$5, $1, $3, $4, $6}' | awk 'NR > 1' | sed 's/"GRCh38.99-------------//' | sed 's/"//' >  temp-diff2-1
wc -l temp-diff2-1
bash script-preRank-genes-if-crit-pos temp-diff2-1 > bal.bcell.startBelg.cluster4vs0.clust4Pos.rnk
wc -l  bal.bcell.startBelg.cluster4vs0.clust4Pos.rnk
bash script-preRank-genes-batchRun
rnkFile ##file name with space, a list of 9 rnk files
bash script-gsea-cmds-2
bash script-generate-chea-target-file-LEG-pathway-2-aug-31 > temp-allpaths-fdr-bCellclusters
 cut -f 1  temp-allpaths-fdr-bCellclusters | uniq -c
   1 contrast
  19 bal.bcell.startBelg.cluster4vs2.clust4Pos.h.all.kegg.reactome.v7.1.GseaPreranked.1598902343169
  58 bal.bcell.startBelg.cluster4vs6.clust4Pos.h.all.kegg.reactome.v7.1.GseaPreranked.1598903024942
 116 bal.bcell.startBelg.cluster4vs7.clust4Pos.h.all.kegg.reactome.v7.1.GseaPreranked.1598903230206

cut -f 2  temp-allpaths-fdr-bCellclusters | sort | uniq -c | sort -n | grep -i b | grep -i b.cell
   1 KEGG_B_CELL_RECEPTOR_SIGNALING_PATHWAY
   1 REACTOME_DOWNSTREAM_SIGNALING_EVENTS_OF_B_CELL_RECEPTOR_BCR
   1 REACTOME_SIGNALING_BY_THE_B_CELL_RECEPTOR_BCR
cut -f 2  temp-allpaths-fdr-bCellclusters | sort | uniq > temp-allpaths-fdr-bCellclusters-uniqpaths
bash  script-generate-chea-target-file-LEG-pathway-2-sep-01
     161 temp-bal.bcell.startBelg.cluster4vs0.clust4Pos.h.all.kegg.reactome.v7.1.GseaPreranked.1598901866356-path-nes-p-q.txt
     161 temp-bal.bcell.startBelg.cluster4vs1.clust4Pos.h.all.kegg.reactome.v7.1.GseaPreranked.1598902116116-path-nes-p-q.txt
paste temp-bal.bcell.startBelg.cluster4vs0.clust4Pos.h.all.kegg.reactome.v7.1.GseaPreranked.1598901866356-path-nes-p-q.txt temp-bal.bcell.startBelg.cluster4vs1.clust4Pos.h.all.kegg.reactome.v7.1.GseaPreranked.1598902116116-path-nes-p-q.txt temp-bal.bcell.startBelg.cluster4vs3.clust4Pos.h.all.kegg.reactome.v7.1.GseaPreranked.1598902552782-path-nes-p-q.txt temp-bal.bcell.startBelg.cluster4vs5.clust4Pos.h.all.kegg.reactome.v7.1.GseaPreranked.1598902805491-path-nes-p-q.txt temp-bal.bcell.startBelg.cluster4vs8.clust4Pos.h.all.kegg.reactome.v7.1.GseaPreranked.1598903420198-path-nes-p-q.txt temp-bal.bcell.startBelg.cluster4vs9.clust4Pos.h.all.kegg.reactome.v7.1.GseaPreranked.1598903631247-path-nes-p-q.txt temp-bal.bcell.startBelg.cluster4vs2.clust4Pos.h.all.kegg.reactome.v7.1.GseaPreranked.1598902343169-path-nes-p-q.txt temp-bal.bcell.startBelg.cluster4vs6.clust4Pos.h.all.kegg.reactome.v7.1.GseaPreranked.1598903024942-path-nes-p-q.txt temp-bal.bcell.startBelg.cluster4vs7.clust4Pos.h.all.kegg.reactome.v7.1.GseaPreranked.1598903230206-path-nes-p-q.txt > temp-clust4-9compare-nes-p-q.txt
bash script-marker-clust4-compare-each-clust-signed-FDR-sep-01 | cut -f 2-11 > bal.bcell.startBelg.clust4-compare-each-clust-signed-FDR.path.h.all.kegg.react.txt
bash script-marker-clust4-compare-each-clust-avg-nes > bal.bcell.startBelg.clust4-compare-each-clust.path.avgAbsNES.txt
cat bal.bcell.startBelg.clust4-compare-each-clust.path.avgAbsNES.txt | sort -t '  ' +1 -2n  | tail -n 50 | cut -f 1 > temp-50.genes
a <- c("KEGG_B_CELL_RECEPTOR_SIGNALING_PATHWAY", "REACTOME_DOWNSTREAM_SIGNALING_EVENTS_OF_B_CELL_RECEPTOR_BCR", "REACTOME_SIGNALING_BY_THE_B_CELL_RECEPTOR_BCR")


a <- read.delim("bal.bcell.startBelg.clust4-compare-each-clust-signed-FDR.path.h.all.kegg.react.txt", header = T, row.names=1)
ha <- HeatmapAnnotation(sev = c("mix", "mix", "moderate", "mix", "mix", "mix", "moderate", "mix", "severe"), type=c("plasma", "plasma","plasma","plasma","plasma","plasma", "B cell", "B cell", "B cell"), col = list(sev = c("mix" = "white", "moderate" = "blue", "severe" = "orange"), type=c("plasma" = "green", "B cell" = "yellow")), show_legend = FALSE)

Heatmap(matrix = mat, name = "signed logFDR", column_names_side = "top",  row_names_gp = gpar(fontsize = 7), top_annotation = ha, column_order = 1:9, clustering_distance_rows = "pearson", clustering_method_rows = "centroid", show_heatmap_legend = FALSE, row_names_max_width = max_text_width(
        rownames(mat), 
        gp = gpar(fontsize = 4)
    ))

###union of (pos/neg) LEGs of a pathway, contain duplicated genes
bash script-generate-chea-target-file-LEG-pathway-3-sep-01
###rm dup genes, create chea-TF-$chea.targets.xls file
bash script-generate-chea-target-file-LEG-pathway-3-sep-01-step2
###compute overlap genes 
bash script-generate-chea-target-file-LEG-pathway-3-sep-01-step3 > bal.bcell.startBelg.clust4-compare-each-clust.pathway.net.0
####compute jaccard index, create network
bash script-generate-chea-target-file-LEG-pathway-3-sep-01-step4 bal.bcell.startBelg.clust4-compare-each-clust.pathway.net.0 > bal.bcell.startBelg.clust4-compare-each-clust.pathway.net.1
####clustering network into modules; 15 clusters found
../local_mcl/bin/mcl bal.bcell.startBelg.clust4-compare-each-clust.pathway.net.1  -I 2.0  --abc  -scheme 7
paste temp-bal.bcell.startBelg.cluster4vs2.clust4Pos.h.all.kegg.reactome.v7.1.GseaPreranked.1598902343169-path-nes-p-q.txt      temp-bal.bcell.startBelg.cluster4vs6.clust4Pos.h.all.kegg.reactome.v7.1.GseaPreranked.1598903024942-path-nes-p-q.txt   temp-bal.bcell.startBelg.cluster4vs7.clust4Pos.h.all.kegg.reactome.v7.1.GseaPreranked.1598903230206-path-nes-p-q.txt > temp-3bcell-nes-p-q.txt
###calc avg NES for each pathway
bash script-marker-clust4-compare-each-clust-avg-nes-sep-1 > bal.bcell.startBelg.clust4-compare-each-clust.path.avgNES.txt
vi temp-node-degree.txt
cat bal.bcell.startBelg.clust4-compare-each-clust.pathway.net.1.I20s7 |  awk 'BEGIN {FS = "\t"; OFS = "\t"} 
{
 for(i = 1; i <= NF; i++)
   print $i, NR;
}'
	clust#	Degree
REACTOME_HEDGEHOG_ON_STATE	1	61
REACTOME_REGULATION_OF_RUNX3_EXPRESSION_AND_ACTIVITY	1	61
REACTOME_STABILIZATION_OF_P53	1	61

head -3 temp-mod-assign.txt
node	moduleName
KEGG_PROTEASOME	KEGG_PROTEASOME
KEGG_RIBOSOME	KEGG_RIBOSOME

######TF target enrich analysis
temp-pax5-bach2.gmt (Chea_TF + transfac)
bash tem-script-generate-chea-target-file
cat bal.bcell.startBelg.cluster4vs[267].clust4Pos.rnk | cut -f 1 |  awk '{print toupper($0)}' |sort | uniq > genome-cl267
###12360 genome-cl267
bash script-TF-targets-enrich > bal.bcell.startBelg.cluster4vs267.TF.net.0
bash "/Users/linyongmao/Documents//antiIL10 monkey/dir-TF-db/script-hyperG-test-2-R" bal.bcell.startBelg.cluster4vs267.TF.net.0 > temp-r-input
cat temp-r-res | awk '{print $2}' > bal.bcell.startBelg.cluster4vs267.TF.net.0.p-value
bal.bcell.startBelg.cluster4vs267.TF.net.0.q
paste bal.bcell.startBelg.cluster4vs267.TF.net.0  bal.bcell.startBelg.cluster4vs267.TF.net.0.p-value  bal.bcell.startBelg.cluster4vs267.TF.net.0.q | awk 'BEGIN {FS = "\t"; OFS = "\t"} $8 < 5e-2' | sed 's/       Chea_/  /' | cut -f 1-2 | sort | uniq > bal.bcell.startBelg.cluster4vs267.TF.net.FDR0d05
cut -f 2 bal.bcell.startBelg.cluster4vs267.TF.net.FDR0d05 | sort | uniq -c | sort -n | tail -n 25 | awk '{print $2}' > temp-top25.TFs
bal.bcell.startBelg.cluster4vs267.25TF.net

cat neutralAntibody.txt | awk 'BEGIN {FS = "\t"; OFS = "\t"} $6 == "BAL" ' | cut -f 3,6,22 | sort > temp-COVIM001-bal-ab
cat seuratComb-meta.data.complete.8-3.xls |cut -f 2,16,17,18,32 | sort | uniq > temp
join -t '	' -1 1 -2 2 temp-COVIM001-bal-ab temp-sorted > temp.txt
temp-T1-pbmc.sorted    
cat neutralAntibody.txt | awk 'BEGIN {FS = "\t"; OFS = "\t"} $6 ~ /lasma/ ' | grep -w T1 | cut -f 3,4,6,22 | sort > temp-COVIM001-plasma-ab
join -t '	' -1 1 -2 2  temp-COVIM001-plasma-ab temp-T1-pbmc.sorted > temp.txt
